<!DOCTYPE html>
<!-- ALO CLIENT CHAT v2.4 — Feb 20, 2026 — 16-persona review P0+P1 fixes -->
<!-- Changes: border-color fix, profiles on signup, homework writes to DB,
     chat settings enforcement, privacy bar, header warmth, microcopy improvements,
     homework viewed tracking, inline styles moved to CSS classes -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Alo">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#FDFBF7">
  
  <!-- Preconnect hints for faster iframe load -->
  <link rel="preconnect" href="https://cdn.botpress.cloud">
  <link rel="preconnect" href="https://files.bpcontent.cloud">
  
  <!-- Open Graph — link preview when therapist texts URL to client -->
  <meta property="og:title" content="Alo — Someone to think out loud with">
  <meta property="og:description" content="A private space to process your thoughts and emotions. Your therapist recommended Alo as a companion between sessions.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://kanomelvin-prog.github.io/alo-client-chat-full_v1/">
  <meta property="og:image" content="https://kanomelvin-prog.github.io/alo-client-chat-full_v1/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="description" content="Alo is a personal emotional support companion. Process thoughts between therapy sessions with Socratic questioning.">
  
  <title>Alo — Someone to think out loud with</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-icon">A</div>
      <div class="brand-text">
        <h1 class="brand-name">Alo</h1>
        <span>Someone to think out loud with</span>
      </div>
    </div>
    <div class="header-actions">
      <button id="shareGuestBtn" onclick="showShareModal()">Share</button>
      <div id="guestAuthActions" class="guest-auth-actions">
        <button id="signInBtn" class="btn-primary" onclick="showLoginModal()">Sign In</button>
      </div>
      <div id="connectedActions" class="connected-actions hidden">
        <div id="trustBadge" class="trust-badge">
          <span id="trustBadgeText"></span>
        </div>
        <button id="moreBtn" class="more-btn" onclick="toggleMoreMenu()" aria-label="Menu" aria-haspopup="true" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- More menu (hidden by default) -->
  <div id="moreMenu" class="more-menu hidden">
    <div class="more-menu-backdrop" onclick="toggleMoreMenu()"></div>
    <div class="more-menu-panel" role="menu" aria-label="More options">
      <button class="more-menu-item" role="menuitem" onclick="toggleMoreMenu(); showShareModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        Share
      </button>
      <button class="more-menu-item" role="menuitem" id="moreMessageBtn" onclick="toggleMoreMenu(); showMessageModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Message Therapist
      </button>
      <div class="more-menu-divider" role="separator"></div>
      <button class="more-menu-item more-menu-logout" role="menuitem" onclick="toggleMoreMenu(); handleLogout()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Log Out
      </button>
    </div>
  </div>

  <!-- Privacy assurance bar — shown on first visit, dismissible -->
  <div id="privacyBar" class="privacy-bar">
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
    </svg>
    <span class="privacy-bar-text">Your conversations with Alo are private. Your therapist cannot see what you discuss here.</span>
    <button class="privacy-bar-dismiss" id="privacyBarDismiss" aria-label="Dismiss">&times;</button>
  </div>

  <main id="chatMain">
    <!-- Homework cards (hidden unless client has active homework) -->
    <div id="homeworkContainer" class="homework-container"></div>

    <!-- Chat iframe -->
    <div class="chat-container">
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-message">
          <div class="spinner"></div>
          <p>Loading Alo...</p>
        </div>
      </div>
      
      <iframe
        id="aloFrame"
        src="https://cdn.botpress.cloud/webchat/v3.6/shareable.html?configUrl=https://files.bpcontent.cloud/2026/02/23/18/20260223182519-48H89VYI.json"
        allow="clipboard-read; clipboard-write"
        title="Alo Chat Interface"
        aria-label="Chatbot Conversation Window"
      ></iframe>
    </div>
  </main>

  <footer>
    <div class="crisis-notice">
      Alo helps you think — not a therapist or doctor. <span class="crisis-link">Need help now?</span> <a href="tel:988">988 US</a>.
    </div>
    <div class="footer-links">
      <a href="#" id="termsLink">Terms</a>
      <a href="#" id="privacyLink">Privacy Policy</a>
    </div>
  </footer>

  <!-- Modals container -->
  <div id="modalsContainer"></div>

  <!-- Toast container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script>
    // =====================================================
    // CONFIG
    // =====================================================
    const SUPABASE_URL = 'https://lelsdezstbnzyxvsvbyx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlbHNkZXpzdGJuenl4dnN2Ynl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDk1NDUsImV4cCI6MjA3OTE4NTU0NX0.mm1POxfEEoRXyTF08NsUZOau6qA_UdZJnoUH_5bkQas';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        storage: window.localStorage,
        storageKey: 'alo_client_session',
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    let clientId = null;
    let therapistLink = null;
    let chatSettings = {};
    let connectedTherapistName = '';
    let activeHomework = [];
    let currentHomeworkId = null;

    // =====================================================
    // TOAST NOTIFICATIONS
    // =====================================================
    function showToast(message, duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // =====================================================
    // MODAL SYSTEM
    // =====================================================
    function createModal(title, bodyHTML, options = {}) {
      const {
        confirmLabel = 'Confirm',
        cancelLabel = 'Cancel',
        onConfirm = null,
        onCancel = null,
        showCancel = true,
        dangerous = false
      } = options;

      const modalId = 'modal-' + Date.now();
      const modalHTML = `
        <div class="modal-overlay" id="${modalId}" role="dialog" aria-modal="true" aria-labelledby="${modalId}-title">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="${modalId}-title">${title}</h2>
              <button class="modal-close" aria-label="Close dialog">&times;</button>
            </div>
            <div class="modal-body">
              ${bodyHTML}
            </div>
            <div class="modal-footer">
              ${showCancel ? `<button class="btn-secondary modal-cancel">${cancelLabel}</button>` : ''}
              <button class="btn-primary modal-confirm ${dangerous ? 'btn-danger' : ''}">${confirmLabel}</button>
            </div>
          </div>
        </div>
      `;

      const container = document.getElementById('modalsContainer');
      container.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById(modalId);
      const closeBtn = modal.querySelector('.modal-close');
      const cancelBtn = modal.querySelector('.modal-cancel');
      const confirmBtn = modal.querySelector('.modal-confirm');

      const firstInput = modal.querySelector('input, textarea, select');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 100);
      } else {
        setTimeout(() => confirmBtn.focus(), 100);
      }

      function closeModal() {
        modal.classList.add('closing');
        setTimeout(() => modal.remove(), 300);
      }

      closeBtn.addEventListener('click', () => {
        if (onCancel) onCancel();
        closeModal();
      });

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          if (onCancel) onCancel();
          closeModal();
        });
      }

      confirmBtn.addEventListener('click', async () => {
        if (onConfirm) {
          const result = await onConfirm();
          if (result !== false) closeModal();
        } else {
          closeModal();
        }
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          if (onCancel) onCancel();
          closeModal();
        }
      });

      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape' && document.getElementById(modalId)) {
          if (onCancel) onCancel();
          closeModal();
          document.removeEventListener('keydown', escHandler);
        }
      });

      setTimeout(() => modal.classList.add('show'), 10);

      return modal;
    }

    // =====================================================
    // CONFIRM DIALOG
    // =====================================================
    function showConfirm(title, message, options = {}) {
      return new Promise((resolve) => {
        createModal(
          title,
          `<p>${message}</p>`,
          {
            ...options,
            onConfirm: () => {
              resolve(true);
            },
            onCancel: () => {
              resolve(false);
            }
          }
        );
      });
    }

    // =====================================================
    // UI STATE MANAGEMENT
    // =====================================================
    function showLoggedInNoConnection() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge';
      badgeText.textContent = 'Logged in';
      
      const svg = badge.querySelector('svg');
      if (svg) svg.remove();
      
      // Repurpose the sign-in button as "Link to Therapist" for logged-in-no-connection state
      const signInBtn = document.getElementById('signInBtn');
      signInBtn.textContent = 'Link to Therapist';
      signInBtn.onclick = showConnectModal;
      document.getElementById('guestAuthActions').classList.remove('hidden');
      document.getElementById('connectedActions').classList.add('hidden');
      document.getElementById('moreMenu').classList.add('hidden');
    }

    function showConnectedUI(therapistName, clientName) {
      connectedTherapistName = therapistName;
      const badge = document.getElementById('trustBadge');
      
      badge.className = 'trust-badge connected';
      
      const shieldSvg = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;flex-shrink:0"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>';

      const withText = (clientName === therapistName) ? 'connected' : 'with ' + therapistName;

      badge.innerHTML = shieldSvg + '<span id="trustBadgeText">Hi <span class="editable-name" id="clientNameEditable" role="button" tabindex="0" aria-label="Change your display name">' + clientName + '</span> \u00B7 ' + withText + '</span>';
      
      const nameEl = document.getElementById('clientNameEditable');
      if (nameEl) {
        nameEl.addEventListener('click', showNameEditModal);
        nameEl.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showNameEditModal();
          }
        });
      }
      
      document.getElementById('guestAuthActions').classList.add('hidden');
      document.getElementById('shareGuestBtn').classList.add('hidden');
      document.getElementById('connectedActions').classList.remove('hidden');
      
      // Show/hide message option in more menu
      const msgItem = document.getElementById('moreMessageBtn');
      if (msgItem) {
        msgItem.style.display = chatSettings.allow_messages !== false ? '' : 'none';
      }
    }

    function toggleMoreMenu() {
      const menu = document.getElementById('moreMenu');
      const btn = document.getElementById('moreBtn');
      const isHidden = menu.classList.contains('hidden');
      
      if (isHidden) {
        menu.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
        // Focus first visible menu item
        const firstItem = menu.querySelector('.more-menu-item:not([style*="display: none"])');
        if (firstItem) firstItem.focus();
      } else {
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
        btn.focus(); // Return focus to trigger
      }
    }

    // Arrow key navigation for more menu
    document.addEventListener('keydown', function(e) {
      const menu = document.getElementById('moreMenu');
      if (menu.classList.contains('hidden')) return;
      
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        const items = Array.from(menu.querySelectorAll('.more-menu-item:not([style*="display: none"])'));
        const current = document.activeElement;
        const idx = items.indexOf(current);
        
        if (e.key === 'ArrowDown') {
          const next = idx < items.length - 1 ? idx + 1 : 0;
          items[next].focus();
        } else {
          const prev = idx > 0 ? idx - 1 : items.length - 1;
          items[prev].focus();
        }
      }
    });

    function showNameEditModal() {
      const currentName = document.getElementById('clientNameEditable')?.textContent || '';
      
      createModal('What should we call you?', `
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">This is how you'll appear in Alo. Only you see this.</p>
        <input type="text" id="nameEditInput" value="${currentName}" 
          placeholder="Your preferred name"
          style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;"
          autocomplete="given-name" maxlength="50" />
      `, {
        confirmLabel: 'Save',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const newName = document.getElementById('nameEditInput').value.trim();
          if (!newName) {
            showToast('Please enter a name');
            return false;
          }

          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return false;

            await api(`/rest/v1/profiles?id=eq.${user.id}`, 'PATCH', {
              display_name: newName
            });

            // Update badge immediately
            document.getElementById('clientNameEditable').textContent = newName;
            showToast('Name updated');
          } catch (err) {
            console.error('Name update error:', err);
            showToast('Could not update name. Please try again.');
            return false;
          }
        }
      });
    }

    function resetToGuestUI() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge guest';
      badgeText.textContent = '';
      
      const svg = badge.querySelector('svg');
      if (svg) svg.remove();
      
      document.getElementById('guestAuthActions').classList.remove('hidden');
      const signInBtn = document.getElementById('signInBtn');
      signInBtn.textContent = 'Sign In';
      signInBtn.onclick = function() { showLoginModal(); };
      signInBtn.classList.remove('hidden');
      document.getElementById('shareGuestBtn').classList.remove('hidden');
      document.getElementById('connectedActions').classList.add('hidden');
      document.getElementById('moreMenu').classList.add('hidden');
      document.getElementById('homeworkContainer').classList.remove('show');
    }

    // =====================================================
    // HOMEWORK
    // =====================================================
    async function loadHomework() {
      if (chatSettings.allow_homework === false) {
        return;
      }

      try {
        const homework = await api(`/rest/v1/homework_cards?client_id=eq.${clientId}&is_active=eq.true&order=created_at.desc`);
        
        if (!homework || homework.length === 0) {
          document.getElementById('homeworkContainer').innerHTML = '';
          document.getElementById('homeworkContainer').classList.remove('show');
          return;
        }

        activeHomework = homework;
        const container = document.getElementById('homeworkContainer');
        const therapistName = connectedTherapistName || 'your therapist';

        container.innerHTML = homework.map(function(hw) {
          return '<div class="homework-card" id="hwCard-' + hw.id + '" data-hw-id="' + hw.id + '">' +
            '<div class="homework-header">' +
              '<div>' +
                '<div class="homework-from">From ' + therapistName + '</div>' +
                '<h3 class="homework-title">' + (hw.title || 'Practice exercise') + '</h3>' +
              '</div>' +
              '<button class="homework-collapse" aria-label="Collapse homework details" aria-expanded="true" data-hw-id="' + hw.id + '">\u2212</button>' +
            '</div>' +
            '<div class="homework-body" id="hwBody-' + hw.id + '">' +
              (hw.homework_type ? '<span class="homework-type-tag">' + hw.homework_type + '</span>' : '') +
              '<p class="homework-goal">' + (hw.goal || '') + '</p>' +
              '<div class="homework-actions">' +
                '<button class="btn-primary homework-done-btn" data-hw-id="' + hw.id + '">Mark complete</button>' +
                '<button class="btn-link homework-hide-btn" data-hw-id="' + hw.id + '">Hide for now</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        container.classList.add('show');

        // Attach event listeners
        container.querySelectorAll('.homework-collapse').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var hwId = this.dataset.hwId;
            var body = document.getElementById('hwBody-' + hwId);
            var isCollapsed = body.classList.contains('collapsed');
            body.classList.toggle('collapsed');
            this.textContent = isCollapsed ? '\u2212' : '+';
            this.setAttribute('aria-expanded', isCollapsed ? 'true' : 'false');
            this.setAttribute('aria-label', isCollapsed ? 'Collapse homework details' : 'Expand homework details');
          });
        });

        container.querySelectorAll('.homework-done-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            handleHomeworkDone(this.dataset.hwId);
          });
        });

        container.querySelectorAll('.homework-hide-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            handleHomeworkHide(this.dataset.hwId);
          });
        });

        // Write viewed_at for any homework not yet viewed
        for (var i = 0; i < homework.length; i++) {
          if (!homework[i].viewed_at) {
            try {
              await api('/rest/v1/homework_cards?id=eq.' + homework[i].id, 'PATCH', {
                viewed_at: new Date().toISOString()
              });
            } catch (viewErr) {
              console.error('Error writing viewed_at:', viewErr);
            }
          }
        }

      } catch (err) {
        console.error('Error loading homework:', err);
      }
    }

    function handleHomeworkDone(hwId) {
      showConfirm(
        'Nice work!',
        'This will be marked as complete.',
        {
          confirmLabel: 'Done',
          cancelLabel: 'Not yet'
        }
      ).then(async function(confirmed) {
        if (!confirmed) return;

        var card = document.getElementById('hwCard-' + hwId);
        
        try {
          await api('/rest/v1/homework_cards?id=eq.' + hwId, 'PATCH', {
            is_active: false,
            completed_at: new Date().toISOString()
          });

          if (card) {
            var body = card.querySelector('.homework-body');
            card.classList.add('completed');
            if (body) body.innerHTML = '<p class="homework-complete-note">Completed just now</p>';
            
            setTimeout(function() {
              if (body) body.classList.add('collapsed');
              var collapseBtn = card.querySelector('.homework-collapse');
              if (collapseBtn) {
                collapseBtn.textContent = '+';
                collapseBtn.setAttribute('aria-expanded', 'false');
              }
            }, 3000);
          }

          showToast('Marked complete \u2014 nice work!');
        } catch (err) {
          console.error('Error completing homework:', err);
          showToast('Could not save. Please try again.');
        }
      });
    }

    function handleHomeworkHide(hwId) {
      var card = document.getElementById('hwCard-' + hwId);
      if (!card) return;

      var body = card.querySelector('.homework-body');
      if (body) body.classList.add('collapsed');
      card.classList.add('minimized');
      
      var collapseBtn = card.querySelector('.homework-collapse');
      if (collapseBtn) {
        collapseBtn.textContent = '+';
        collapseBtn.setAttribute('aria-expanded', 'false');
        collapseBtn.setAttribute('aria-label', 'Expand homework details');
      }
    }

    // =====================================================
    // LOGOUT HANDLER
    // =====================================================
    async function handleLogout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Error signing out:', error);
        showToast('Error signing out. Please try again.');
        return;
      }
      
      clientId = null;
      therapistLink = null;
      chatSettings = {};
      currentHomeworkId = null;
      
      location.reload();
    }

    // =====================================================
    // CONNECT MODAL
    // =====================================================
    function showConnectModal() {
      createModal('Link to Your Therapist', `
        <p>Stay connected with your therapist between sessions. They can send you exercises, and you can message them anytime.</p>
        <p class="modal-hint">Your conversations with Alo are between you and Alo — your therapist never sees them.</p>
        <div style="margin-top: 16px;">
          <label for="inviteCodeInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Invite code</label>
          <input type="text" id="inviteCodeInput" class="modal-input" placeholder="Enter the code your therapist gave you" autocomplete="off" />
        </div>
        <p class="modal-sign-in-link">
          Already have an account? <button onclick="const c=document.getElementById('inviteCodeInput')?.value?.trim(); document.querySelector('.modal-overlay').remove(); showLoginModal(c||null);">Sign in</button>
        </p>
      `, {
        confirmLabel: 'Link',
        cancelLabel: 'Maybe later',
        onConfirm: async () => {
          const code = document.getElementById('inviteCodeInput').value.trim();
          if (!code) {
            showToast('Please enter an invite code');
            return false;
          }
          await handleConnectSubmit(code);
        }
      });
    }

    async function handleConnectSubmit(inviteCode) {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        showLoginModal(inviteCode);
        return;
      }

      try {
        const link = await api(`/rest/v1/therapist_clients?invite_code=eq.${inviteCode}&status=eq.pending`);
        
        if (!link || link.length === 0) {
          showToast('Invalid invite code. Check the code your therapist sent you.');
          return;
        }

        const linkId = link[0].id;
        const therapistDisplayName = link[0].display_name || null;

        await api(`/rest/v1/therapist_clients?id=eq.${linkId}`, 'PATCH', {
          client_id: user.id,
          status: 'active'
        });

        // Seed client profile with therapist's chosen name (client can change later)
        if (therapistDisplayName) {
          const existingProfile = await api(`/rest/v1/profiles?id=eq.${user.id}&select=display_name`);
          const currentName = existingProfile?.[0]?.display_name;
          if (!currentName || currentName === user.email?.split('@')[0]) {
            await api(`/rest/v1/profiles?id=eq.${user.id}`, 'PATCH', {
              display_name: therapistDisplayName
            });
          }
        }

        showToast('Connected successfully!');
        await loadConnectedState();
      } catch (err) {
        console.error('Connection error:', err);
        showToast('Connection failed. Please try again.');
      }
    }

    // =====================================================
    // LOGIN MODAL
    // =====================================================
    function showLoginModal(inviteCode = null) {
      createModal('Sign In or Create Account', `
        <p>Create an account or sign in to connect with your therapist.</p>
        <div style="margin-top: 16px;">
          <label for="emailInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Email</label>
          <input type="email" id="emailInput" class="modal-input" placeholder="Email" autocomplete="email" style="margin-bottom: 12px;" />
          <label for="passwordInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Password</label>
          <input type="password" id="passwordInput" class="modal-input" placeholder="Password" autocomplete="current-password" />
        </div>
        <p class="modal-sign-in-link" style="margin-top: 12px;">
          Have an invite code from your therapist? <button onclick="document.querySelector('.modal-overlay').remove(); showConnectModal();">Link to Therapist</button>
        </p>
      `, {
        confirmLabel: 'Continue',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const email = document.getElementById('emailInput').value.trim();
          const password = document.getElementById('passwordInput').value;
          
          if (!email || !password) {
            showToast('Please enter email and password');
            return false;
          }

          // Try sign in first
          let { data, error } = await supabase.auth.signInWithPassword({ email, password });
          
          // If sign in fails, try sign up
          if (error && error.message.includes('Invalid login credentials')) {
            const signUpResult = await supabase.auth.signUp({ email, password });
            
            if (signUpResult.error) {
              showToast('Authentication failed. Please try again.');
              return false;
            }
            
            if (!signUpResult.data.session) {
              showToast('Account created! Check your email to confirm.');
              return;
            }
            
            data = signUpResult.data;
            error = null;

            // P0: Create profiles row on sign-up
            try {
              const displayName = email.split('@')[0];
              await api('/rest/v1/profiles', 'POST', {
                id: data.user.id,
                role: 'individual',
                display_name: displayName,
                email: email
              });
            } catch (profileErr) {
              // Non-blocking — profile creation failure shouldn't break signup
              console.error('Error creating profile:', profileErr);
            }
          }

          if (error) {
            showToast('Authentication failed. Please try again.');
            return false;
          }

          showToast('Signed in successfully');

          if (inviteCode) {
            await handleConnectSubmit(inviteCode);
          } else {
            await loadConnectedState();
          }
        }
      });
    }

    // =====================================================
    // MESSAGE MODAL
    // =====================================================
    function showMessageModal() {
      const therapistName = connectedTherapistName || 'your therapist';
      
      createModal(`Message ${therapistName}`, `
        <p class="modal-subtext">
          ${therapistName} will see this message in their dashboard. They'll respond when they can.
        </p>
        <textarea id="messageTextarea" class="modal-textarea" placeholder="Type your message..."></textarea>
      `, {
        confirmLabel: 'Send',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const messageText = document.getElementById('messageTextarea').value.trim();
          if (!messageText) {
            showToast('Please enter a message');
            return false;
          }

          try {
            await api('/rest/v1/client_messages', 'POST', {
              client_id: clientId,
              therapist_id: therapistLink.therapist_id,
              content: messageText,
              read: false
            });

            showToast('Message sent');
          } catch (err) {
            console.error('Error sending message:', err);
            showToast('Failed to send message. Please try again.');
            return false;
          }
        }
      });
    }

    // =====================================================
    // PRIVACY MODAL
    // =====================================================
    function showPrivacyModal() {
      const therapistName = connectedTherapistName || 'your therapist';
      
      createModal('Your Privacy', `
        <h3 class="modal-section-title">What ${therapistName} sees</h3>
        <ul class="modal-list">
          <li>Whether you're connected to Alo</li>
          <li>If you completed homework exercises</li>
          <li>Messages you send them directly</li>
          <li>How often you use Alo (not what you discuss)</li>
        </ul>
        
        <h3 class="modal-section-title">What they never see</h3>
        <ul class="modal-list">
          <li><strong>Your conversations with Alo</strong> — there is no way for them to access these</li>
          <li>What you talked about or how you're feeling</li>
          <li>Only you decide what to share with your therapist</li>
        </ul>
        
        <p class="modal-divider">
          Alo is your space. Your therapist trusts you to share what matters when you're ready.
        </p>
      `, {
        confirmLabel: 'Got it',
        showCancel: false
      });
    }

    // =====================================================
    // SHARE MODAL (3-option: Summary/Full/Range)
    // =====================================================
    function showShareModal() {
      const summaryPrompt = `Alo, please create a 5-bullet summary of our conversation for me to share with my therapist or someone I trust. Include key insights and one suggested next step.`;
      const recapPrompt = `Alo, please reconstruct our conversation as a back-and-forth recap in "You said... Alo said..." format. Keep it concise — paraphrase rather than quoting exactly. Include the key moments and turning points.`;
      
      const modal = createModal('Share Your Conversation', `
        <div class="share-options">
          <button class="share-option active" id="optionSummary">
            <span class="share-option-icon">\u{1F4DD}</span>
            <span class="share-option-label">Summary</span>
          </button>
          <button class="share-option" id="optionRecap">
            <span class="share-option-icon">\u{1F4AC}</span>
            <span class="share-option-label">Recap</span>
          </button>
        </div>
        
        <div id="instructionsArea">
          <div id="summaryInstructions">
            <p class="share-instructions">
              Get a 5-bullet summary perfect for sharing with your therapist
            </p>
            <ol class="share-steps">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates a summary</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="share-prompt-box">
              <textarea readonly id="summaryPromptText" class="share-prompt-textarea">${summaryPrompt}</textarea>
              <button id="copySummaryBtn" class="btn-primary" style="width: 100%; margin-top: 8px;">\u{1F4CB} Copy Message</button>
            </div>
          </div>
          
          <div id="recapInstructions" style="display: none;">
            <p class="share-instructions">
              Get a back-and-forth recap of what you discussed
            </p>
            <ol class="share-steps">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo reconstructs the conversation</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="share-prompt-box">
              <textarea readonly id="recapPromptText" class="share-prompt-textarea">${recapPrompt}</textarea>
              <button id="copyRecapBtn" class="btn-primary" style="width: 100%; margin-top: 8px;">\u{1F4CB} Copy Message</button>
            </div>
            <p class="share-hint">
              \u{1F4A1} This is a paraphrased reconstruction, not an exact transcript
            </p>
          </div>
        </div>
        
        <p class="share-footer-note">
          <strong>How to share:</strong> After Alo creates your summary or recap, long-press on it and select "Copy". Then paste into Messages, Email, or Notes.
        </p>
      `, {
        confirmLabel: 'Close',
        showCancel: false
      });
      
      setupShareTabs(modal, summaryPrompt, recapPrompt);
    }

    function setupShareTabs(modal, summaryPrompt, recapPrompt) {
      const optionSummary = modal.querySelector('#optionSummary');
      const optionRecap = modal.querySelector('#optionRecap');
      
      const summaryInstructions = modal.querySelector('#summaryInstructions');
      const recapInstructions = modal.querySelector('#recapInstructions');
      
      function switchTab(tab) {
        [optionSummary, optionRecap].forEach(btn => btn.classList.remove('active'));
        summaryInstructions.style.display = 'none';
        recapInstructions.style.display = 'none';
        
        if (tab === 'summary') {
          optionSummary.classList.add('active');
          summaryInstructions.style.display = 'block';
        } else if (tab === 'recap') {
          optionRecap.classList.add('active');
          recapInstructions.style.display = 'block';
        }
      }
      
      optionSummary.addEventListener('click', () => switchTab('summary'));
      optionRecap.addEventListener('click', () => switchTab('recap'));
      
      const copySummaryBtn = modal.querySelector('#copySummaryBtn');
      const copyRecapBtn = modal.querySelector('#copyRecapBtn');
      
      copySummaryBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(summaryPrompt);
        if (success) {
          copySummaryBtn.textContent = '\u2713 Copied!';
          copySummaryBtn.style.background = '#10b981';
          setTimeout(function() {
            copySummaryBtn.textContent = '\u{1F4CB} Copy Message';
            copySummaryBtn.style.background = '';
          }, 2000);
        }
      });
      
      copyRecapBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(recapPrompt);
        if (success) {
          copyRecapBtn.textContent = '\u2713 Copied!';
          copyRecapBtn.style.background = '#10b981';
          setTimeout(function() {
            copyRecapBtn.textContent = '\u{1F4CB} Copy Message';
            copyRecapBtn.style.background = '';
          }, 2000);
        }
      });
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textArea);
        return success;
      }
    }

    // =====================================================
    // API HELPER
    // =====================================================
    async function api(endpoint, method = 'GET', body = null) {
      const { data: { session } } = await supabase.auth.getSession();
      
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': session ? `Bearer ${session.access_token}` : `Bearer ${SUPABASE_ANON_KEY}`
        }
      };

      if (body && method !== 'GET') {
        options.body = JSON.stringify(body);
      }

      // For POST, add Prefer header to get minimal response
      if (method === 'POST') {
        options.headers['Prefer'] = 'return=minimal';
      }

      const response = await fetch(`${SUPABASE_URL}${endpoint}`, options);
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const text = await response.text();
      return text ? JSON.parse(text) : null;
    }

    // =====================================================
    // LOAD CONNECTED STATE
    // =====================================================
    // =====================================================
    // BOTPRESS BRIDGE — IDs available for future use
    // Crisis events written directly from Botpress via axios
    // =====================================================

    async function loadConnectedState() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          resetToGuestUI();
          return;
        }

        const links = await api(`/rest/v1/therapist_clients?client_id=eq.${user.id}&status=eq.active`);

        if (!links || links.length === 0) {
          showLoggedInNoConnection();
          return;
        }

        therapistLink = links[0];
        clientId = user.id;

        const therapist = await api(`/rest/v1/profiles?id=eq.${therapistLink.therapist_id}&select=display_name`);
        const client = await api(`/rest/v1/profiles?id=eq.${user.id}&select=display_name`);

        const therapistName = therapist?.[0]?.display_name || 'Your therapist';
        // Fallback chain: client's own profile name → therapist's label → 'there'
        const clientProfileName = client?.[0]?.display_name;
        const therapistLabel = therapistLink.display_name;
        const clientName = clientProfileName || therapistLabel || 'there';

        // P1: Read ALL chat settings — column names match dashboard's saveClientEdit()
        const settings = await api(`/rest/v1/therapist_clients?id=eq.${therapistLink.id}&select=allow_homework,allow_messages,allow_summary,allow_history`);
        chatSettings = settings?.[0] || {};

        showConnectedUI(therapistName, clientName);
        await loadHomework();

        // Write session start to session_metadata (fire-and-forget)
        const sessionId = 'ses_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);
        api('/rest/v1/session_metadata', 'POST', {
          client_id: clientId,
          session_id: sessionId
        }).catch(err => console.error('Session metadata write failed:', err));

      } catch (err) {
        console.error('Error loading connected state:', err);
      }
    }

    // =====================================================
    // PRIVACY BAR
    // =====================================================
    function initPrivacyBar() {
      const bar = document.getElementById('privacyBar');
      const dismissBtn = document.getElementById('privacyBarDismiss');
      
      // Check if user has dismissed it before
      if (localStorage.getItem('alo_privacy_bar_dismissed')) {
        bar.style.display = 'none';
        return;
      }

      dismissBtn.addEventListener('click', () => {
        bar.style.display = 'none';
        localStorage.setItem('alo_privacy_bar_dismissed', 'true');
      });
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function() {
      const iframe = document.getElementById('aloFrame');
      const loadingOverlay = document.getElementById('loadingOverlay');
      let loadTimeout;

      iframe.addEventListener('load', function() {
        loadingOverlay.style.display = 'none';
        clearTimeout(loadTimeout);
      });

      loadTimeout = setTimeout(function() {
        loadingOverlay.innerHTML = `
          <div class="error-message">
            <p><strong>Still loading...</strong></p>
            <p>This is taking longer than usual. Let's try again.</p>
            <button onclick="location.reload()" class="btn-primary">Retry</button>
            <p style="font-size: 13px; margin-top: 20px; color: var(--text-secondary);">
              Need help now? Call <a href="tel:988" style="color: var(--text-primary);">988</a>
            </p>
          </div>
        `;
      }, 15000);

      // Privacy bar
      initPrivacyBar();

      // Sign In and Connect use inline onclick handlers
      // Close more menu on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const menu = document.getElementById('moreMenu');
          if (!menu.classList.contains('hidden')) toggleMoreMenu();
        }
      });
      
      // Homework event listeners are attached dynamically in loadHomework()

      document.getElementById('termsLink').addEventListener('click', function(e) {
        e.preventDefault();
        createModal('Terms of Use', `
          <p>Alo is a conversational companion, not a replacement for professional mental health care.</p>
          <p style="margin-top: 12px;"><strong>By using Alo, you agree that:</strong></p>
          <ul class="modal-list">
            <li>Alo does not provide medical advice, diagnosis, or treatment</li>
            <li>You will seek professional help for mental health crises</li>
            <li>Your therapist does not see your conversations with Alo</li>
            <li>You are responsible for deciding what to share with your therapist</li>
          </ul>
          <p class="modal-divider">
            If you're in crisis, call <strong>988</strong> (US Suicide & Crisis Lifeline) or go to your nearest emergency room.
          </p>
        `, {
          confirmLabel: 'I understand',
          showCancel: false
        });
      });

      document.getElementById('privacyLink').addEventListener('click', function(e) {
        e.preventDefault();
        createModal('Privacy Policy', `
          <h3 class="modal-section-title">What we store</h3>
          <ul class="modal-list">
            <li>Account information (email, password hash)</li>
            <li>Connection to your therapist</li>
            <li>Homework completion status</li>
            <li>Messages you send to your therapist</li>
          </ul>

          <h3 class="modal-section-title">Your Alo conversations</h3>
          <ul class="modal-list">
            <li>Conversations are processed by our chat provider to power the experience</li>
            <li>Chat data is <strong>not permanently stored</strong> — it is automatically deleted</li>
            <li>Your therapist <strong>cannot access</strong> your Alo conversations</li>
            <li>Conversations are not used for training, analytics, or advertising</li>
          </ul>

          <h3 class="modal-section-title">Who sees your data</h3>
          <ul class="modal-list">
            <li>Your therapist sees homework status and messages you send them</li>
            <li>Your therapist <strong>never</strong> sees your Alo conversations</li>
            <li>We don't sell or share your data with third parties</li>
          </ul>

          <h3 class="modal-section-title">Security</h3>
          <ul class="modal-list">
            <li>All stored data is encrypted at rest (AES-256) and in transit (TLS)</li>
            <li>Chat data is encrypted at rest and in transit by our chat provider</li>
            <li>Database access is controlled by row-level security — your therapist can only see their own clients</li>
          </ul>

          <p class="modal-divider">
            Questions about your privacy? Ask your therapist.
          </p>
        `, {
          confirmLabel: 'Got it',
          showCancel: false
        });
      });

      // Listen for auth state changes
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN') {
          loadConnectedState();
        } else if (event === 'SIGNED_OUT') {
          resetToGuestUI();
        }
      });

      // Check for existing session
      const { data: { session } } = await supabase.auth.getSession();

      if (session) {
        await loadConnectedState();
      }
    });
  </script>
</body>
</html>
