<!DOCTYPE html>
<!-- v3.0 — Feb 27, 2026 — Conversation persistence + thread sidebar -->
<!-- Changes: Teal-blue color palette, light/dark mode toggle,
     system preference detection, theme persistence via localStorage,
     WCAG AA contrast compliance, nighttime-optimized dark mode -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Alowen">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#F3EDE4" id="metaThemeColor">
  
  <!-- Prevent flash of wrong theme — runs before first paint -->
  <script>
    (function() {
      var saved = localStorage.getItem('alo_theme');
      if (saved === 'dark' || saved === 'light') {
        document.documentElement.setAttribute('data-theme', saved);
        var meta = document.getElementById('metaThemeColor');
        if (meta) meta.content = saved === 'dark' ? '#111917' : '#F3EDE4';
      }
    })();
  </script>
  
  <!-- Botpress JS SDK -->
  <link rel="preconnect" href="https://cdn.botpress.cloud">
  <link rel="preconnect" href="https://files.bpcontent.cloud">
  <script src="https://cdn.botpress.cloud/webchat/v3.3/inject.js"></script>
  
  <!-- Open Graph — link preview when therapist texts URL to client -->
  <meta property="og:title" content="Alowen — Someone to think out loud with">
  <meta property="og:description" content="A private space to process your thoughts and emotions. Your therapist recommended Alowen as a companion between sessions.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://alowen.ai/">
  <meta property="og:image" content="https://alowen.ai/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="description" content="Alowen is a personal emotional support companion. Process thoughts between therapy sessions with Socratic questioning.">
  
  <title>Alowen — Someone to think out loud with</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-icon">A</div>
      <div class="brand-text">
        <h1 class="brand-name">Alowen</h1>
        <span>Someone to think out loud with</span>
      </div>
    </div>
    <div class="header-actions">
      <button id="threadsBtn" class="threads-btn hidden" onclick="toggleThreadSidebar()" aria-label="Conversation history">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      </button>
      <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark mode">
        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </button>
      <button id="shareGuestBtn" onclick="showShareModal()">Share</button>
      <div id="guestAuthActions" class="guest-auth-actions">
        <button id="signInBtn" class="btn-primary" onclick="showLoginModal()">Sign In</button>
      </div>
      <div id="connectedActions" class="connected-actions hidden">
        <div id="trustBadge" class="trust-badge">
          <span id="trustBadgeText"></span>
        </div>
        <button id="moreBtn" class="more-btn" onclick="toggleMoreMenu()" aria-label="Menu" aria-haspopup="true" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- More menu (hidden by default) -->
  <div id="moreMenu" class="more-menu hidden">
    <div class="more-menu-backdrop" onclick="toggleMoreMenu()"></div>
    <div class="more-menu-panel" role="menu" aria-label="More options">
      <button class="more-menu-item" role="menuitem" onclick="toggleMoreMenu(); toggleThreadSidebar()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
        Conversations
      </button>
      <button class="more-menu-item" role="menuitem" onclick="toggleMoreMenu(); showShareModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        Share
      </button>
      <button class="more-menu-item" role="menuitem" id="moreMessageBtn" onclick="toggleMoreMenu(); showMessageModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>
        Message Therapist
      </button>
      <div class="more-menu-divider" role="separator"></div>
      <button class="more-menu-item more-menu-logout" role="menuitem" onclick="toggleMoreMenu(); handleLogout()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Log Out
      </button>
    </div>
  </div>

  <!-- Thread sidebar (slide-in panel) -->
  <div id="threadSidebar" class="thread-sidebar" aria-label="Conversation history">
    <div class="thread-sidebar-header">
      <h2>Conversations</h2>
      <button class="thread-sidebar-close" onclick="toggleThreadSidebar()" aria-label="Close sidebar">&times;</button>
    </div>
    <button class="thread-new-btn" onclick="startNewConversation()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      New conversation
    </button>
    <div id="threadList" class="thread-list">
      <div class="thread-list-empty">No conversations yet.<br>Start chatting and they'll appear here.</div>
    </div>
    <div class="thread-sidebar-footer">
      <div class="memory-toggle-row">
        <div>
          <div class="memory-toggle-label">Alo remembers context</div>
          <span class="memory-toggle-sublabel">Past conversations inform new ones</span>
        </div>
        <label class="toggle-switch">
          <input type="checkbox" id="memoryToggle" checked onchange="handleMemoryToggle(this.checked)">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>
  </div>
  <div id="threadBackdrop" class="thread-sidebar-backdrop" onclick="toggleThreadSidebar()"></div>

  <!-- Memory save prompt bar (shown to guests after conversation depth) -->
  <div id="memoryPromptBar" class="memory-prompt-bar">
    <span class="memory-prompt-text">Want Alo to remember your conversations?</span>
    <button class="memory-prompt-btn" onclick="showLoginModal(); hideMemoryPrompt();">Create Account</button>
    <button class="memory-prompt-dismiss" onclick="hideMemoryPrompt()" aria-label="Dismiss">&times;</button>
  </div>

  <!-- Privacy assurance bar — shown on first visit, dismissible -->
  <div id="privacyBar" class="privacy-bar">
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
    </svg>
    <span class="privacy-bar-text">Your conversations with Alo are private. Your therapist cannot see what you discuss here.</span>
    <button class="privacy-bar-dismiss" id="privacyBarDismiss" aria-label="Dismiss">&times;</button>
  </div>

  <main id="chatMain">
    <!-- Homework cards (hidden unless client has active homework) -->
    <div id="homeworkContainer" class="homework-container"></div>

    <!-- Chat iframe -->
    <div class="chat-container">
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-message">
          <div class="spinner"></div>
          <p>Loading Alo...</p>
        </div>
      </div>
      
      <div id="aloFrame" aria-label="Chatbot Conversation Window"></div>
    </div>
  </main>

  <footer>
    <div class="crisis-notice">
      Alo helps you think — not a therapist or doctor. <span class="crisis-link">Need help now?</span> <a href="tel:988">988 US</a>.
    </div>
    <div class="footer-links">
      <a href="#" id="termsLink">Terms</a>
      <a href="#" id="privacyLink">Privacy Policy</a>
    </div>
  </footer>

  <!-- Modals container -->
  <div id="modalsContainer"></div>

  <!-- Toast container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script>
    // =====================================================
    // CONFIG
    // =====================================================
    const SUPABASE_URL = 'https://lelsdezstbnzyxvsvbyx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlbHNkZXpzdGJuenl4dnN2Ynl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDk1NDUsImV4cCI6MjA3OTE4NTU0NX0.mm1POxfEEoRXyTF08NsUZOau6qA_UdZJnoUH_5bkQas';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        storage: window.localStorage,
        storageKey: 'alo_client_session',
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    let clientId = null;
    let therapistLink = null;
    let sessionNonce = null;
    let chatSettings = {};
    let connectedTherapistName = '';
    let activeHomework = [];
    let currentHomeworkId = null;

    // Conversation persistence state
    let currentSupabaseConvId = null;
    let seenMessageIds = new Set();
    let persistenceTurnCounter = 0;
    let authBridgeSent = false;

    // =====================================================
    // UTILITY
    // =====================================================
    function esc(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // =====================================================
    // THEME TOGGLE
    // =====================================================
    function getEffectiveTheme() {
      var saved = localStorage.getItem('alo_theme');
      if (saved === 'dark' || saved === 'light') return saved;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function toggleTheme() {
      var current = getEffectiveTheme();
      var next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('alo_theme', next);
      
      // Update meta theme-color for mobile browser chrome
      var meta = document.getElementById('metaThemeColor');
      if (meta) meta.content = next === 'dark' ? '#111917' : '#F3EDE4';
    }

    // =====================================================
    // TOAST NOTIFICATIONS
    // =====================================================
    function showToast(message, duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // =====================================================
    // MODAL SYSTEM
    // =====================================================
    function createModal(title, bodyHTML, options = {}) {
      const {
        confirmLabel = 'Confirm',
        cancelLabel = 'Cancel',
        onConfirm = null,
        onCancel = null,
        showCancel = true,
        dangerous = false
      } = options;

      const modalId = 'modal-' + Date.now();
      const modalHTML = `
        <div class="modal-overlay" id="${modalId}" role="dialog" aria-modal="true" aria-labelledby="${modalId}-title">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="${modalId}-title">${title}</h2>
              <button class="modal-close" aria-label="Close dialog">&times;</button>
            </div>
            <div class="modal-body">
              ${bodyHTML}
            </div>
            <div class="modal-footer">
              ${showCancel ? `<button class="btn-secondary modal-cancel">${cancelLabel}</button>` : ''}
              <button class="btn-primary modal-confirm ${dangerous ? 'btn-danger' : ''}">${confirmLabel}</button>
            </div>
          </div>
        </div>
      `;

      const container = document.getElementById('modalsContainer');
      container.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById(modalId);
      const closeBtn = modal.querySelector('.modal-close');
      const cancelBtn = modal.querySelector('.modal-cancel');
      const confirmBtn = modal.querySelector('.modal-confirm');

      const firstInput = modal.querySelector('input, textarea, select');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 100);
      } else {
        setTimeout(() => confirmBtn.focus(), 100);
      }

      function closeModal() {
        modal.classList.add('closing');
        setTimeout(() => modal.remove(), 300);
      }

      closeBtn.addEventListener('click', () => {
        if (onCancel) onCancel();
        closeModal();
      });

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          if (onCancel) onCancel();
          closeModal();
        });
      }

      confirmBtn.addEventListener('click', async () => {
        if (onConfirm) {
          const result = await onConfirm();
          if (result !== false) closeModal();
        } else {
          closeModal();
        }
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          if (onCancel) onCancel();
          closeModal();
        }
      });

      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape' && document.getElementById(modalId)) {
          if (onCancel) onCancel();
          closeModal();
          document.removeEventListener('keydown', escHandler);
        }
      });

      setTimeout(() => modal.classList.add('show'), 10);

      return modal;
    }

    // =====================================================
    // CONFIRM DIALOG
    // =====================================================
    function showConfirm(title, message, options = {}) {
      return new Promise((resolve) => {
        createModal(
          title,
          `<p>${message}</p>`,
          {
            ...options,
            onConfirm: () => {
              resolve(true);
            },
            onCancel: () => {
              resolve(false);
            }
          }
        );
      });
    }

    // =====================================================
    // UI STATE MANAGEMENT
    // =====================================================
    function showLoggedInNoConnection() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge';
      badgeText.textContent = 'Logged in';
      
      // Show threads button for any logged-in user
      document.getElementById('threadsBtn').classList.remove('hidden');
      loadMemorySettings();
      
      const svg = badge.querySelector('svg');
      if (svg) svg.remove();
      
      // Repurpose the sign-in button as "Link to Therapist" for logged-in-no-connection state
      const signInBtn = document.getElementById('signInBtn');
      signInBtn.textContent = 'Link to Therapist';
      signInBtn.onclick = showConnectModal;
      document.getElementById('guestAuthActions').classList.remove('hidden');
      document.getElementById('connectedActions').classList.add('hidden');
      document.getElementById('moreMenu').classList.add('hidden');
    }

    function showConnectedUI(therapistName, clientName) {
      connectedTherapistName = therapistName;
      const badge = document.getElementById('trustBadge');
      
      badge.className = 'trust-badge connected';
      
      const shieldSvg = '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;flex-shrink:0"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>';

      const safeClient = esc(clientName);
      const safeTherapist = esc(therapistName);
      const withText = (clientName === therapistName) ? 'connected' : 'with ' + safeTherapist;

      badge.innerHTML = shieldSvg + '<span id="trustBadgeText">Hi <span class="editable-name" id="clientNameEditable" role="button" tabindex="0" aria-label="Change your display name">' + safeClient + '</span> \u00B7 ' + withText + '</span>';
      
      const nameEl = document.getElementById('clientNameEditable');
      if (nameEl) {
        nameEl.addEventListener('click', showNameEditModal);
        nameEl.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showNameEditModal();
          }
        });
      }
      
      document.getElementById('guestAuthActions').classList.add('hidden');
      document.getElementById('shareGuestBtn').classList.add('hidden');
      document.getElementById('connectedActions').classList.remove('hidden');
      
      // Show/hide message option in more menu
      const msgItem = document.getElementById('moreMessageBtn');
      if (msgItem) {
        msgItem.style.display = chatSettings.allow_messages !== false ? '' : 'none';
      }
    }

    function toggleMoreMenu() {
      const menu = document.getElementById('moreMenu');
      const btn = document.getElementById('moreBtn');
      const isHidden = menu.classList.contains('hidden');
      
      if (isHidden) {
        menu.classList.remove('hidden');
        btn.setAttribute('aria-expanded', 'true');
        // Focus first visible menu item
        const firstItem = menu.querySelector('.more-menu-item:not([style*="display: none"])');
        if (firstItem) firstItem.focus();
      } else {
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
        btn.focus(); // Return focus to trigger
      }
    }

    // Arrow key navigation for more menu
    document.addEventListener('keydown', function(e) {
      const menu = document.getElementById('moreMenu');
      if (menu.classList.contains('hidden')) return;
      
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        const items = Array.from(menu.querySelectorAll('.more-menu-item:not([style*="display: none"])'));
        const current = document.activeElement;
        const idx = items.indexOf(current);
        
        if (e.key === 'ArrowDown') {
          const next = idx < items.length - 1 ? idx + 1 : 0;
          items[next].focus();
        } else {
          const prev = idx > 0 ? idx - 1 : items.length - 1;
          items[prev].focus();
        }
      }
    });

    function showNameEditModal() {
      const currentName = document.getElementById('clientNameEditable')?.textContent || '';
      
      createModal('What should we call you?', `
        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">This is how you'll appear in Alo. Only you see this.</p>
        <input type="text" id="nameEditInput" value="${currentName}" 
          placeholder="Your preferred name"
          style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px;"
          autocomplete="given-name" maxlength="50" />
      `, {
        confirmLabel: 'Save',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const newName = document.getElementById('nameEditInput').value.trim();
          if (!newName) {
            showToast('Please enter a name');
            return false;
          }

          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return false;

            await api(`/rest/v1/profiles?id=eq.${user.id}`, 'PATCH', {
              display_name: newName
            });

            // Update badge immediately
            document.getElementById('clientNameEditable').textContent = newName;
            showToast('Name updated');
          } catch (err) {
            console.error('Name update error:', err);
            showToast('Could not update name. Please try again.');
            return false;
          }
        }
      });
    }

    function resetToGuestUI() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge guest';
      badgeText.textContent = '';
      
      // Hide threads button for guests
      document.getElementById('threadsBtn').classList.add('hidden');
      
      const svg = badge.querySelector('svg');
      if (svg) svg.remove();
      
      document.getElementById('guestAuthActions').classList.remove('hidden');
      const signInBtn = document.getElementById('signInBtn');
      signInBtn.textContent = 'Sign In';
      signInBtn.onclick = function() { showLoginModal(); };
      signInBtn.classList.remove('hidden');
      document.getElementById('shareGuestBtn').classList.remove('hidden');
      document.getElementById('connectedActions').classList.add('hidden');
      document.getElementById('moreMenu').classList.add('hidden');
      document.getElementById('homeworkContainer').classList.remove('show');
    }

    // =====================================================
    // HOMEWORK
    // =====================================================
    async function loadHomework() {
      if (chatSettings.allow_homework === false || !clientId) {
        return;
      }

      try {
        const homework = await api(`/rest/v1/homework_cards?client_id=eq.${clientId}&is_active=eq.true&order=created_at.desc`);
        
        if (!homework || homework.length === 0) {
          document.getElementById('homeworkContainer').innerHTML = '';
          document.getElementById('homeworkContainer').classList.remove('show');
          return;
        }

        activeHomework = homework;
        const container = document.getElementById('homeworkContainer');
        const therapistName = connectedTherapistName || 'your therapist';

        container.innerHTML = homework.map(function(hw) {
          return '<div class="homework-card" id="hwCard-' + hw.id + '" data-hw-id="' + hw.id + '">' +
            '<div class="homework-header">' +
              '<div>' +
                '<div class="homework-from">From ' + therapistName + '</div>' +
                '<h3 class="homework-title">' + (hw.title || 'Practice exercise') + '</h3>' +
              '</div>' +
              '<button class="homework-collapse" aria-label="Collapse homework details" aria-expanded="true" data-hw-id="' + hw.id + '">\u2212</button>' +
            '</div>' +
            '<div class="homework-body" id="hwBody-' + hw.id + '">' +
              (hw.homework_type ? '<span class="homework-type-tag">' + hw.homework_type + '</span>' : '') +
              '<p class="homework-goal">' + (hw.goal || '') + '</p>' +
              '<div class="homework-actions">' +
                '<button class="btn-primary homework-done-btn" data-hw-id="' + hw.id + '">Mark complete</button>' +
                '<button class="btn-link homework-hide-btn" data-hw-id="' + hw.id + '">Collapse</button>' +
              '</div>' +
            '</div>' +
          '</div>';
        }).join('');

        container.classList.add('show');

        // Attach event listeners
        container.querySelectorAll('.homework-collapse').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var hwId = this.dataset.hwId;
            var body = document.getElementById('hwBody-' + hwId);
            var isCollapsed = body.classList.contains('collapsed');
            body.classList.toggle('collapsed');
            this.textContent = isCollapsed ? '\u2212' : '+';
            this.setAttribute('aria-expanded', isCollapsed ? 'true' : 'false');
            this.setAttribute('aria-label', isCollapsed ? 'Collapse homework details' : 'Expand homework details');
          });
        });

        container.querySelectorAll('.homework-done-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            handleHomeworkDone(this.dataset.hwId);
          });
        });

        container.querySelectorAll('.homework-hide-btn').forEach(function(btn) {
          btn.addEventListener('click', function() {
            handleHomeworkHide(this.dataset.hwId);
          });
        });

        // Write viewed_at for any homework not yet viewed
        for (var i = 0; i < homework.length; i++) {
          if (!homework[i].viewed_at) {
            try {
              await api('/rest/v1/homework_cards?id=eq.' + homework[i].id, 'PATCH', {
                viewed_at: new Date().toISOString()
              });
            } catch (viewErr) {
              console.error('Error writing viewed_at:', viewErr);
            }
          }
        }

      } catch (err) {
        console.error('Error loading homework:', err);
      }
    }

    function handleHomeworkDone(hwId) {
      showConfirm(
        'Nice work!',
        'This will be marked as complete.',
        {
          confirmLabel: 'Done',
          cancelLabel: 'Not yet'
        }
      ).then(async function(confirmed) {
        if (!confirmed) return;

        var card = document.getElementById('hwCard-' + hwId);
        
        try {
          await api('/rest/v1/homework_cards?id=eq.' + hwId, 'PATCH', {
            is_active: false,
            completed_at: new Date().toISOString()
          });

          if (card) {
            var body = card.querySelector('.homework-body');
            card.classList.add('completed');
            if (body) body.innerHTML = '<p class="homework-complete-note">Completed just now</p>';
            
            setTimeout(function() {
              if (body) body.classList.add('collapsed');
              var collapseBtn = card.querySelector('.homework-collapse');
              if (collapseBtn) {
                collapseBtn.textContent = '+';
                collapseBtn.setAttribute('aria-expanded', 'false');
              }
            }, 3000);
          }

          showToast('Marked complete \u2014 nice work!');
        } catch (err) {
          console.error('Error completing homework:', err);
          showToast('Could not save. Please try again.');
        }
      });
    }

    function handleHomeworkHide(hwId) {
      var card = document.getElementById('hwCard-' + hwId);
      if (!card) return;

      var body = card.querySelector('.homework-body');
      if (body) body.classList.add('collapsed');
      card.classList.add('minimized');
      
      var collapseBtn = card.querySelector('.homework-collapse');
      if (collapseBtn) {
        collapseBtn.textContent = '+';
        collapseBtn.setAttribute('aria-expanded', 'false');
        collapseBtn.setAttribute('aria-label', 'Expand homework details');
      }
    }

    // =====================================================
    // LOGOUT HANDLER
    // =====================================================
    async function handleLogout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Error signing out:', error);
        showToast('Error signing out. Please try again.');
        return;
      }
      
      clientId = null;
      therapistLink = null;
      chatSettings = {};
      currentHomeworkId = null;
      
      location.reload();
    }

    // =====================================================
    // CONNECT MODAL
    // =====================================================
    function showConnectModal() {
      createModal('Link to Your Therapist', `
        <p>Stay connected with your therapist between sessions. They can send you exercises, and you can message them anytime.</p>
        <p class="modal-hint">Your conversations with Alo are between you and Alo — your therapist never sees them.</p>
        <div style="margin-top: 16px;">
          <label for="inviteCodeInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Invite code</label>
          <input type="text" id="inviteCodeInput" class="modal-input" placeholder="Enter the code your therapist gave you" autocomplete="off" />
        </div>
        <p class="modal-sign-in-link">
          Already have an account? <button onclick="const c=document.getElementById('inviteCodeInput')?.value?.trim(); document.querySelector('.modal-overlay').remove(); showLoginModal(c||null);">Sign in</button>
        </p>
      `, {
        confirmLabel: 'Link',
        cancelLabel: 'Maybe later',
        onConfirm: async () => {
          const code = document.getElementById('inviteCodeInput').value.trim();
          if (!code) {
            showToast('Please enter an invite code');
            return false;
          }
          await handleConnectSubmit(code);
        }
      });
    }

    async function handleConnectSubmit(inviteCode) {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        showLoginModal(inviteCode);
        return;
      }

      try {
        const link = await api(`/rest/v1/therapist_clients?invite_code=eq.${inviteCode}&status=eq.pending`);
        
        if (!link || link.length === 0) {
          showToast('Invalid invite code. Check the code your therapist sent you.');
          return;
        }

        const linkId = link[0].id;
        const therapistDisplayName = link[0].display_name || null;

        await api(`/rest/v1/therapist_clients?id=eq.${linkId}`, 'PATCH', {
          client_id: user.id,
          status: 'active'
        });

        // Seed client profile with therapist's chosen name (client can change later)
        if (therapistDisplayName) {
          const existingProfile = await api(`/rest/v1/profiles?id=eq.${user.id}&select=display_name`);
          const currentName = existingProfile?.[0]?.display_name;
          if (!currentName || currentName === user.email?.split('@')[0]) {
            await api(`/rest/v1/profiles?id=eq.${user.id}`, 'PATCH', {
              display_name: therapistDisplayName
            });
          }
        }

        showToast('Connected successfully!');
        await loadConnectedState();
      } catch (err) {
        console.error('Connection error:', err);
        showToast('Connection failed. Please try again.');
      }
    }

    // =====================================================
    // LOGIN MODAL
    // =====================================================
    function showLoginModal(inviteCode = null) {
      createModal('Sign In or Create Account', `
        <p>Create an account to save your conversations and let Alo remember what you've discussed.</p>
        <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Your conversations stay private. Signing in does not share anything.</p>
        <div style="margin-top: 16px;">
          <label for="emailInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Email</label>
          <input type="email" id="emailInput" class="modal-input" placeholder="Email" autocomplete="email" style="margin-bottom: 12px;" />
          <label for="passwordInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Password</label>
          <input type="password" id="passwordInput" class="modal-input" placeholder="Password" autocomplete="current-password" />
        </div>
        <p class="modal-sign-in-link" style="margin-top: 12px;">
          Have an invite code from your therapist? <button onclick="document.querySelector('.modal-overlay').remove(); showConnectModal();">Link to Therapist</button>
        </p>
      `, {
        confirmLabel: 'Continue',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const email = document.getElementById('emailInput').value.trim();
          const password = document.getElementById('passwordInput').value;
          
          if (!email || !password) {
            showToast('Please enter email and password');
            return false;
          }

          // Try sign in first
          let { data, error } = await supabase.auth.signInWithPassword({ email, password });
          
          // If sign in fails, try sign up
          if (error && error.message.includes('Invalid login credentials')) {
            const signUpResult = await supabase.auth.signUp({ email, password });
            
            if (signUpResult.error) {
              showToast('Authentication failed. Please try again.');
              return false;
            }
            
            if (!signUpResult.data.session) {
              showToast('Account created! Check your email to confirm.');
              return;
            }
            
            data = signUpResult.data;
            error = null;

            // P0: Create profiles row on sign-up
            try {
              const displayName = email.split('@')[0];
              await api('/rest/v1/profiles', 'POST', {
                id: data.user.id,
                role: 'individual',
                display_name: displayName,
                email: email
              });
            } catch (profileErr) {
              // Non-blocking — profile creation failure shouldn't break signup
              console.error('Error creating profile:', profileErr);
            }
          }

          if (error) {
            showToast('Authentication failed. Please try again.');
            return false;
          }

          showToast('Signed in successfully');

          if (inviteCode) {
            await handleConnectSubmit(inviteCode);
          } else {
            await loadConnectedState();
          }
        }
      });
    }

    // =====================================================
    // MESSAGE MODAL
    // =====================================================
    function showMessageModal() {
      const therapistName = connectedTherapistName || 'your therapist';
      
      createModal(`Message ${therapistName}`, `
        <p class="modal-subtext">
          ${therapistName} will see this message in their dashboard. They'll respond when they can.
        </p>
        <textarea id="messageTextarea" class="modal-textarea" placeholder="Type your message..."></textarea>
      `, {
        confirmLabel: 'Send',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const messageText = document.getElementById('messageTextarea').value.trim();
          if (!messageText) {
            showToast('Please enter a message');
            return false;
          }

          try {
            await api('/rest/v1/client_messages', 'POST', {
              client_id: clientId,
              therapist_id: therapistLink.therapist_id,
              content: messageText,
              read: false
            });

            showToast('Message sent');
          } catch (err) {
            console.error('Error sending message:', err);
            showToast('Failed to send message. Please try again.');
            return false;
          }
        }
      });
    }

    // =====================================================
    // PRIVACY MODAL
    // =====================================================
    function showPrivacyModal() {
      const therapistName = connectedTherapistName || 'your therapist';
      
      createModal('Your Privacy', `
        <h3 class="modal-section-title">What ${therapistName} sees</h3>
        <ul class="modal-list">
          <li>Whether you're connected to Alo</li>
          <li>If you completed homework exercises</li>
          <li>Messages you send them directly</li>
          <li>How often you use Alo (not what you discuss)</li>
        </ul>
        
        <h3 class="modal-section-title">What they never see</h3>
        <ul class="modal-list">
          <li><strong>Your conversations with Alo</strong> — there is no way for them to access these</li>
          <li>What you talked about or how you're feeling</li>
          <li>Only you decide what to share with your therapist</li>
        </ul>
        
        <p class="modal-divider">
          Alo is your space. Your therapist trusts you to share what matters when you're ready.
        </p>
      `, {
        confirmLabel: 'Got it',
        showCancel: false
      });
    }

    // =====================================================
    // SHARE MODAL (3-option: Summary/Full/Range)
    // =====================================================
    function showShareModal() {
      const summaryPrompt = `Alo, please create a 5-bullet summary of our conversation for me to share with my therapist or someone I trust. Include key insights and one suggested next step.`;
      const recapPrompt = `Alo, please reconstruct our conversation as a back-and-forth recap in "You said... Alo said..." format. Keep it concise — paraphrase rather than quoting exactly. Include the key moments and turning points.`;
      
      const modal = createModal('Share Your Conversation', `
        <div class="share-options">
          <button class="share-option active" id="optionSummary">
            <span class="share-option-icon">\u{1F4DD}</span>
            <span class="share-option-label">Summary</span>
          </button>
          <button class="share-option" id="optionRecap">
            <span class="share-option-icon">\u{1F4AC}</span>
            <span class="share-option-label">Recap</span>
          </button>
        </div>
        
        <div id="instructionsArea">
          <div id="summaryInstructions">
            <p class="share-instructions">
              Get a 5-bullet summary perfect for sharing with your therapist
            </p>
            <ol class="share-steps">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates a summary</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="share-prompt-box">
              <textarea readonly id="summaryPromptText" class="share-prompt-textarea">${summaryPrompt}</textarea>
              <button id="copySummaryBtn" class="btn-primary" style="width: 100%; margin-top: 8px;">\u{1F4CB} Copy Message</button>
            </div>
          </div>
          
          <div id="recapInstructions" style="display: none;">
            <p class="share-instructions">
              Get a back-and-forth recap of what you discussed
            </p>
            <ol class="share-steps">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo reconstructs the conversation</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="share-prompt-box">
              <textarea readonly id="recapPromptText" class="share-prompt-textarea">${recapPrompt}</textarea>
              <button id="copyRecapBtn" class="btn-primary" style="width: 100%; margin-top: 8px;">\u{1F4CB} Copy Message</button>
            </div>
            <p class="share-hint">
              \u{1F4A1} This is a paraphrased reconstruction, not an exact transcript
            </p>
          </div>
        </div>
        
        <p class="share-footer-note">
          <strong>How to share:</strong> After Alo creates your summary or recap, long-press on it and select "Copy". Then paste into Messages, Email, or Notes.
        </p>
      `, {
        confirmLabel: 'Close',
        showCancel: false
      });
      
      setupShareTabs(modal, summaryPrompt, recapPrompt);
    }

    function setupShareTabs(modal, summaryPrompt, recapPrompt) {
      const optionSummary = modal.querySelector('#optionSummary');
      const optionRecap = modal.querySelector('#optionRecap');
      
      const summaryInstructions = modal.querySelector('#summaryInstructions');
      const recapInstructions = modal.querySelector('#recapInstructions');
      
      function switchTab(tab) {
        [optionSummary, optionRecap].forEach(btn => btn.classList.remove('active'));
        summaryInstructions.style.display = 'none';
        recapInstructions.style.display = 'none';
        
        if (tab === 'summary') {
          optionSummary.classList.add('active');
          summaryInstructions.style.display = 'block';
        } else if (tab === 'recap') {
          optionRecap.classList.add('active');
          recapInstructions.style.display = 'block';
        }
      }
      
      optionSummary.addEventListener('click', () => switchTab('summary'));
      optionRecap.addEventListener('click', () => switchTab('recap'));
      
      const copySummaryBtn = modal.querySelector('#copySummaryBtn');
      const copyRecapBtn = modal.querySelector('#copyRecapBtn');
      
      copySummaryBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(summaryPrompt);
        if (success) {
          copySummaryBtn.textContent = '\u2713 Copied!';
          copySummaryBtn.style.background = 'var(--success)';
          setTimeout(function() {
            copySummaryBtn.textContent = '\u{1F4CB} Copy Message';
            copySummaryBtn.style.background = '';
          }, 2000);
        }
      });
      
      copyRecapBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(recapPrompt);
        if (success) {
          copyRecapBtn.textContent = '\u2713 Copied!';
          copyRecapBtn.style.background = 'var(--success)';
          setTimeout(function() {
            copyRecapBtn.textContent = '\u{1F4CB} Copy Message';
            copyRecapBtn.style.background = '';
          }, 2000);
        }
      });
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textArea);
        return success;
      }
    }

    // =====================================================
    // API HELPER
    // =====================================================
    async function api(endpoint, method = 'GET', body = null) {
      const { data: { session } } = await supabase.auth.getSession();
      
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': session ? `Bearer ${session.access_token}` : `Bearer ${SUPABASE_ANON_KEY}`
        }
      };

      if (body && method !== 'GET') {
        options.body = JSON.stringify(body);
      }

      // For POST, add Prefer header to get minimal response
      if (method === 'POST') {
        options.headers['Prefer'] = 'return=minimal';
      }

      const response = await fetch(`${SUPABASE_URL}${endpoint}`, options);
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const text = await response.text();
      return text ? JSON.parse(text) : null;
    }

    // =====================================================
    // LOAD CONNECTED STATE
    // =====================================================
    // =====================================================
    // BOTPRESS BRIDGE — IDs available for future use
    // Crisis events written directly from Botpress via axios
    // =====================================================

    async function loadConnectedState() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          resetToGuestUI();
          return;
        }

        const links = await api(`/rest/v1/therapist_clients?client_id=eq.${user.id}&status=eq.active`);

        if (!links || links.length === 0) {
          clientId = user.id;
          showLoggedInNoConnection();
          return;
        }

        therapistLink = links[0];
        clientId = user.id;

        const therapist = await api(`/rest/v1/profiles?id=eq.${therapistLink.therapist_id}&select=display_name`);
        const client = await api(`/rest/v1/profiles?id=eq.${user.id}&select=display_name`);

        const therapistName = therapist?.[0]?.display_name || 'Your therapist';
        // Fallback chain: client's own profile name → therapist's label → 'there'
        const clientProfileName = client?.[0]?.display_name;
        const therapistLabel = therapistLink.display_name;
        const clientName = clientProfileName || therapistLabel || 'there';

        // P1: Read ALL chat settings — column names match dashboard's saveClientEdit()
        const settings = await api(`/rest/v1/therapist_clients?id=eq.${therapistLink.id}&select=allow_homework,allow_messages,allow_summary,allow_history`);
        chatSettings = settings?.[0] || {};

        showConnectedUI(therapistName, clientName);
        
        // Show threads button and load memory settings
        document.getElementById('threadsBtn').classList.remove('hidden');
        await loadMemorySettings();
        
        await loadHomework();

        // Generate nonce, write session start, and send identity to Botpress
        const sessionId = 'ses_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);
        sessionNonce = crypto.randomUUID();
        api('/rest/v1/session_metadata', 'POST', {
          client_id: clientId,
          session_id: sessionId,
          nonce: sessionNonce
        }).then(() => {
          // Send identity to Botpress after nonce is written to DB
          if (window.botpress) {
            const hwSummary = activeHomework.length > 0
              ? activeHomework.map(h => ({ title: h.title, type: h.homework_type, goal: h.goal }))
              : [];
            window.botpress.updateUser({
              data: {
                sessionNonce: sessionNonce,
                clientId: clientId,
                homeworkActive: JSON.stringify(hwSummary)
              }
            });
            console.log('[Alo] Identity + homework sent to Botpress via updateUser');
          }
        }).catch(err => console.error('Session metadata write failed:', err));

        // Send identity to Botpress via Custom Trigger (auth bridge)
        sendAuthBridge();

      } catch (err) {
        console.error('Error loading connected state:', err);
      }
    }

    // =====================================================
    // CONVERSATION PERSISTENCE
    // =====================================================
    async function ensureConversation(botpressConvId) {
      if (!clientId || !botpressConvId) return null;

      var storageKey = 'alo_conv_' + botpressConvId;
      var existingId = localStorage.getItem(storageKey);

      if (existingId) {
        currentSupabaseConvId = existingId;
        try {
          var { data } = await supabase
            .from('conversations')
            .select('turn_count')
            .eq('id', existingId)
            .single();
          persistenceTurnCounter = data?.turn_count || 0;
        } catch (e) {
          persistenceTurnCounter = 0;
        }
        console.log('[Persistence] Resumed conversation:', existingId);
        return existingId;
      }

      var now = new Date();
      var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      var hrs = now.getHours();
      var mins = String(now.getMinutes()).padStart(2, '0');
      var ampm = hrs >= 12 ? 'PM' : 'AM';
      var hr12 = hrs % 12 || 12;
      var title = months[now.getMonth()] + ' ' + now.getDate() + ', ' + now.getFullYear() + ' · ' + hr12 + ':' + mins + ' ' + ampm;

      var { data, error } = await supabase
        .from('conversations')
        .insert({
          client_id: clientId,
          title: title,
          botpress_conversation_id: botpressConvId,
          turn_count: 0
        })
        .select('id')
        .single();

      if (error) {
        console.error('[Persistence] Failed to create conversation:', error.message);
        return null;
      }

      currentSupabaseConvId = data.id;
      localStorage.setItem(storageKey, data.id);
      persistenceTurnCounter = 0;
      console.log('[Persistence] Created conversation:', data.id);
      return data.id;
    }

    async function saveMessage(role, content, botpressMessageId) {
      if (!currentSupabaseConvId || !content) return;
      if (botpressMessageId && seenMessageIds.has(botpressMessageId)) return;
      if (botpressMessageId) seenMessageIds.add(botpressMessageId);

      persistenceTurnCounter++;

      var insertData = {
        conversation_id: currentSupabaseConvId,
        role: role,
        content: content,
        turn_number: persistenceTurnCounter
      };
      if (botpressMessageId) {
        insertData.botpress_msg_id = botpressMessageId;
      }

      console.log('[Persistence] Saving ' + role + ':', content.substring(0, 40), 'msgId:', botpressMessageId);
      var { error } = await supabase
        .from('conversation_messages')
        .upsert(insertData, { onConflict: 'botpress_msg_id' });

      if (error) {
        console.error('[Persistence] FAILED ' + role + ':', error.message, error.details, error.hint);
      } else {
        console.log('[Persistence] Saved ' + role + ' message OK');
        // Update turn_count on conversation row so memory can filter short convos
        supabase.from('conversations').update({ turn_count: persistenceTurnCounter, updated_at: new Date().toISOString() }).eq('id', currentSupabaseConvId).then(function() {});
      }
    }

    function resetPersistenceState() {
      currentSupabaseConvId = null;
      seenMessageIds.clear();
      persistenceTurnCounter = 0;
    }

    function sendAuthBridge() {
      if (authBridgeSent || !clientId) return;
      if (!window.botpress || typeof window.botpress.sendEvent !== 'function') {
        setTimeout(sendAuthBridge, 500);
        return;
      }
      authBridgeSent = true;
      try {
        window.botpress.sendEvent({
          bp_event: 'alo_auth_bridge_v1',
          clientId: clientId
        });
        console.log('[Alo] Auth bridge sent to Botpress');
      } catch (e) {
        console.warn('[Alo] Auth bridge sendEvent failed:', e);
    authBridgeSent = false;
    setTimeout(sendAuthBridge, 1000);
  }
      try {
        window.botpress.updateUser({
          userKey: clientId,
          data: { clientId: clientId }
        });
      } catch (e) {}
    } 

    // =====================================================
    // PRIVACY BAR
    // =====================================================
    function initPrivacyBar() {
      const bar = document.getElementById('privacyBar');
      const dismissBtn = document.getElementById('privacyBarDismiss');
      
      // Check if user has dismissed it before
      if (localStorage.getItem('alo_privacy_bar_dismissed')) {
        bar.style.display = 'none';
        return;
      }

      dismissBtn.addEventListener('click', () => {
        bar.style.display = 'none';
        localStorage.setItem('alo_privacy_bar_dismissed', 'true');
      });
    }
// =====================================================
    // THREAD SIDEBAR + MEMORY FEATURES
    // =====================================================
    
    let allThreads = [];
    let guestTurnCount = 0;

    function toggleThreadSidebar() {
      const sidebar = document.getElementById('threadSidebar');
      const backdrop = document.getElementById('threadBackdrop');
      const isOpen = sidebar.classList.contains('open');
      
      if (isOpen) {
        sidebar.classList.remove('open');
        backdrop.classList.remove('show');
        document.getElementById('threadsBtn').focus();
      } else {
        sidebar.classList.add('open');
        backdrop.classList.add('show');
        loadThreads();
        const firstBtn = sidebar.querySelector('button');
        if (firstBtn) firstBtn.focus();
      }
    }

    async function loadThreads() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      try {
        const threads = await api(`/rest/v1/conversations?client_id=eq.${user.id}&order=updated_at.desc&limit=50`);
        allThreads = threads || [];
        renderThreadList();
      } catch (err) {
        console.error('Error loading threads:', err);
      }
    }

    function renderThreadList() {
      const container = document.getElementById('threadList');
      
      if (!allThreads || allThreads.length === 0) {
        container.innerHTML = '<div class="thread-list-empty">No conversations yet.<br>Start chatting and they\'ll appear here.</div>';
        return;
      }

      container.innerHTML = allThreads.map(function(thread) {
        const turnText = thread.turn_count === 1 ? '1 turn' : (thread.turn_count || 0) + ' turns';
        return '<div class="thread-item" data-id="' + thread.id + '">' +
          '<div class="thread-item-content">' +
            '<div class="thread-item-title">' + esc(thread.title || 'Untitled') + '</div>' +
            '<div class="thread-item-meta">' + turnText + '</div>' +
          '</div>' +
          '<div class="thread-item-actions">' +
            '<button class="thread-action-btn" data-action="rename" data-id="' + thread.id + '" data-title="' + esc(thread.title || '') + '" aria-label="Rename">' +
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>' +
            '</button>' +
            '<button class="thread-action-btn danger" data-action="delete" data-id="' + thread.id + '" aria-label="Delete">' +
              '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>' +
            '</button>' +
          '</div>' +
        '</div>';
      }).join('');

      container.querySelectorAll('.thread-item').forEach(function(item) {
        item.addEventListener('click', function() {
          viewTranscript(this.dataset.id);
        });
      });
      container.querySelectorAll('[data-action="rename"]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          renameThread(this.dataset.id, this.dataset.title);
        });
      });
      container.querySelectorAll('[data-action="delete"]').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          deleteThread(this.dataset.id);
        });
      });
    }

    async function viewTranscript(conversationId) {
      try {
        const messages = await api(`/rest/v1/conversation_messages?conversation_id=eq.${conversationId}&order=turn_number.asc,created_at.asc`);
        
        const thread = allThreads.find(t => t.id === conversationId);
        const title = thread ? thread.title : 'Conversation';

        let bodyHTML = '<div class="transcript-container">';
        
        if (!messages || messages.length === 0) {
          bodyHTML += '<div class="transcript-empty">No messages in this conversation.</div>';
        } else {
          for (var i = 0; i < messages.length; i++) {
            const msg = messages[i];
            const roleClass = msg.role === 'user' ? 'user' : 'assistant';
            bodyHTML += '<div class="transcript-message ' + roleClass + '">' + esc(msg.content) + '</div>';
          }
        }
        
        bodyHTML += '</div>';

        toggleThreadSidebar();
        createModal(esc(title), bodyHTML, {
          confirmLabel: 'Close',
          showCancel: false
        });
      } catch (err) {
        console.error('Error loading transcript:', err);
        showToast('Could not load conversation');
      }
    }

    function renameThread(conversationId, currentTitle) {
      createModal('Rename Conversation', `
        <input type="text" id="renameInput" value="${currentTitle}" 
          placeholder="Give this conversation a name"
          style="width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; background: var(--surface); color: var(--text-primary);"
          maxlength="200" />
      `, {
        confirmLabel: 'Save',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const newTitle = document.getElementById('renameInput').value.trim();
          if (!newTitle) {
            showToast('Please enter a name');
            return false;
          }

          try {
            await api(`/rest/v1/conversations?id=eq.${conversationId}`, 'PATCH', {
              title: newTitle
            });

            const thread = allThreads.find(t => t.id === conversationId);
            if (thread) thread.title = newTitle;
            renderThreadList();
            showToast('Renamed');
          } catch (err) {
            console.error('Error renaming:', err);
            showToast('Could not rename. Try again.');
            return false;
          }
        }
      });
    }

    async function deleteThread(conversationId) {
      const confirmed = await showConfirm(
        'Delete conversation?',
        'This permanently deletes this conversation and its messages. This can\'t be undone.',
        {
          confirmLabel: 'Delete',
          cancelLabel: 'Keep',
          dangerous: true
        }
      );

      if (!confirmed) return;

      try {
        await api(`/rest/v1/conversations?id=eq.${conversationId}`, 'DELETE');
        
        allThreads = allThreads.filter(t => t.id !== conversationId);
        renderThreadList();
        showToast('Conversation deleted');
      } catch (err) {
        console.error('Error deleting:', err);
        showToast('Could not delete. Try again.');
      }
    }

    async function handleMemoryToggle(enabled) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      try {
        const existing = await api(`/rest/v1/client_settings?client_id=eq.${user.id}&select=client_id`);

        if (existing && existing.length > 0) {
          await api(`/rest/v1/client_settings?client_id=eq.${user.id}`, 'PATCH', {
            memory_enabled: enabled,
            updated_at: new Date().toISOString()
          });
        } else {
          await api('/rest/v1/client_settings', 'POST', {
            client_id: user.id,
            memory_enabled: enabled
          });
        }

        showToast(enabled ? 'Memory enabled' : 'Memory turned off');
      } catch (err) {
        console.error('Error updating memory setting:', err);
        showToast('Could not update setting');
        document.getElementById('memoryToggle').checked = !enabled;
      }
    }

    async function loadMemorySettings() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      try {
        const settings = await api(`/rest/v1/client_settings?client_id=eq.${user.id}&select=memory_enabled`);
        if (settings && settings.length > 0) {
          document.getElementById('memoryToggle').checked = settings[0].memory_enabled !== false;
        }
      } catch (err) {
        document.getElementById('memoryToggle').checked = true;
      }
    }

    async function startNewConversation() {
      const confirmed = await showConfirm(
        'Start new conversation?',
        'This will start a fresh conversation with Alo. Your current conversation is saved in your history.',
        { confirmLabel: 'Start fresh', cancelLabel: 'Keep chatting' }
      );
      if (!confirmed) return;

      resetPersistenceState();
      authBridgeSent = false;
      toggleThreadSidebar();
      
      const aloFrame = document.getElementById('aloFrame');
      const chatContainer = document.querySelector('.chat-container');
      
      const existingWebchat = document.querySelector('.bpWebchat');
      if (existingWebchat) existingWebchat.remove();
      
      window.botpress.init({
        botId: 'fc0fad71-daea-4d22-adf5-3a659042d46a',
        clientId: 'fc13c6c1-ac2b-4114-bf9b-1e73e2a89b3e',
        selector: '#aloFrame',
        configuration: {
          version: 'v2',
          botName: ' ',
          botAvatar: 'https://files.bpcontent.cloud/2026/02/06/16/20260206161656-T77YC5WL.jpeg',
          botDescription: '',
          color: '#3A7C86',
          variant: 'soft',
          headerVariant: 'glass',
          themeMode: getEffectiveTheme(),
          fontFamily: 'inter',
          radius: 1,
          feedbackEnabled: false,
          soundEnabled: false,
          conversationHistory: false
        }
      });

      var reinitCheck = setInterval(function() {
        if (window.botpress) {
          try {
            window.botpress.open();
            var webchatIframe = document.querySelector('.bpWebchat');
            if (chatContainer && webchatIframe) {
              chatContainer.appendChild(webchatIframe);
            }
            if (clientId) {
              var hwSummary = activeHomework.length > 0
                ? activeHomework.map(function(h) { return { title: h.title, type: h.homework_type, goal: h.goal }; })
                : [];
              window.botpress.updateUser({
                data: {
                  sessionNonce: sessionNonce,
                  clientId: clientId,
                  homeworkActive: JSON.stringify(hwSummary)
                }
              });
            }
            sendAuthBridge();
            clearInterval(reinitCheck);
          } catch (e) {
            // Not ready yet
          }
        }
      }, 200);

      setTimeout(function() { clearInterval(reinitCheck); }, 5000);
    }

    function checkGuestMemoryPrompt() {
      guestTurnCount++;
      if (guestTurnCount >= 5 && !clientId && !localStorage.getItem('alo_memory_prompt_dismissed')) {
        const bar = document.getElementById('memoryPromptBar');
        if (bar) bar.classList.add('show');
      }
    }

    function hideMemoryPrompt() {
      const bar = document.getElementById('memoryPromptBar');
      if (bar) bar.classList.remove('show');
      localStorage.setItem('alo_memory_prompt_dismissed', 'true');
    }

    // =====================================================
    // BOTPRESS LAYOUT — position webchat iframe over chat-container
    // Botpress mounts iframes at <body> level, not inside #aloFrame.
    // We reposition the webchat iframe to exactly cover .chat-container.
    // =====================================================
    
    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function() {
      const loadingOverlay = document.getElementById('loadingOverlay');
      let loadTimeout;

      // Initialize Botpress JS SDK immediately (guest mode)
      // userData will be sent later via updateUser() once auth resolves
      window.botpress.init({
        botId: 'fc0fad71-daea-4d22-adf5-3a659042d46a',
        clientId: 'fc13c6c1-ac2b-4114-bf9b-1e73e2a89b3e',
        selector: '#aloFrame',
        configuration: {
          version: 'v2',
          botName: ' ',
          botAvatar: 'https://files.bpcontent.cloud/2026/02/06/16/20260206161656-T77YC5WL.jpeg',
          botDescription: '',
          color: '#3A7C86',
          variant: 'soft',
          headerVariant: 'glass',
          themeMode: getEffectiveTheme(),
          fontFamily: 'inter',
          radius: 1,
          feedbackEnabled: false,
          soundEnabled: false,
          conversationHistory: false
        }
      });

      var botpressReady = false;
      window.botpress.on('webchat:initialized', function() {
        if (botpressReady) return;
        botpressReady = true;

        loadingOverlay.style.display = 'none';
        clearTimeout(loadTimeout);
        window.botpress.open();
        console.log('[Alo] Botpress webchat initialized');

        // Overlay positioning — don't move the iframe (breaks cross-origin),
        // instead position it fixed over .chat-container
        var chatContainer = document.querySelector('.chat-container');
        var webchatEl = document.querySelector('.bpWebchat');
        if (!chatContainer || !webchatEl) {
          console.warn('[Alo] Missing chat-container or .bpWebchat');
          return;
        }

        function positionWebchat() {
          var rect = chatContainer.getBoundingClientRect();
          var top = rect.top;
          var height = rect.height;
          
          // iOS keyboard fix: when visualViewport shrinks (keyboard open),
          // clamp the webchat to the visible area
          if (window.visualViewport) {
            var vv = window.visualViewport;
            var visibleBottom = vv.offsetTop + vv.height;
            if (top + height > visibleBottom) {
              height = Math.max(0, visibleBottom - Math.max(top, vv.offsetTop));
            }
            if (top < vv.offsetTop) {
              top = vv.offsetTop;
            }
          }
          
          webchatEl.style.cssText = 
            'position:fixed!important;' +
            'top:' + top + 'px!important;' +
            'left:' + rect.left + 'px!important;' +
            'width:' + rect.width + 'px!important;' +
            'height:' + height + 'px!important;' +
            'max-height:' + height + 'px!important;' +
            'max-width:' + rect.width + 'px!important;' +
            'border-radius:0!important;' +
            'box-shadow:none!important;' +
            'z-index:10!important;';
        }

        positionWebchat();
        console.log('[Alo] Positioned webchat overlay on .chat-container');

        // Keep in sync on resize, orientation change, iOS keyboard
        var ro = new ResizeObserver(positionWebchat);
        ro.observe(chatContainer);
        window.addEventListener('resize', positionWebchat);
        if (window.visualViewport) {
          window.visualViewport.addEventListener('resize', positionWebchat);
          window.visualViewport.addEventListener('scroll', positionWebchat);
        }
      });

window.botpress.on('webchat:closed', function() {
        window.botpress.open();
      });
      

      // Message capture: persistence for signed-in users + guest turn tracking
      // NOTE: Non-async handler to avoid silent swallowing. Fire-and-forget Supabase writes.
      window.botpress.on('message', function(msg) {
        if (!clientId) {
          checkGuestMemoryPrompt();
          return;
        }

        // Extract text — try all known paths
        var content = '';
        try { content = msg.block.text; } catch(e) {}
        if (!content) try { content = msg.payload.text; } catch(e) {}
        if (!content && typeof msg.text === 'string') content = msg.text;
        if (!content) {
          // Last resort: stringify and extract
          try {
            var raw = JSON.stringify(msg);
            var match = raw.match(/"text":"([^"]+)"/);
            if (match) content = match[1];
          } catch(e) {}
        }
        if (!content) return;

        // Determine role
        var isUser = false;
        try { isUser = !!(msg.metadata && msg.metadata.clientMessageId); } catch(e) {}
        var role = isUser ? 'user' : 'assistant';
        var msgId = null;
        try { msgId = msg.id; } catch(e) {}
        var bpConvId = null;
        try { bpConvId = msg.conversationId; } catch(e) {}

        console.log('[Persistence] Captured ' + role + ': ' + content.substring(0, 40) + ' id:' + msgId);

        // Fire-and-forget: create conversation if needed, then save
        (async function() {
          try {
            if (!currentSupabaseConvId) {
              await ensureConversation(bpConvId || 'conv_' + Date.now());
            }
            await saveMessage(role, content, msgId);
          } catch (err) {
            console.error('[Persistence] Error:', err.message);
          }
        })();
      });
         
      loadTimeout = setTimeout(function() {
        loadingOverlay.innerHTML = `
          <div class="error-message">
            <p><strong>Still loading...</strong></p>
            <p>This is taking longer than usual. Let's try again.</p>
            <button onclick="location.reload()" class="btn-primary">Retry</button>
            <p style="font-size: 13px; margin-top: 20px; color: var(--text-secondary);">
              Need help now? Call <a href="tel:988" style="color: var(--text-primary);">988</a>
            </p>
          </div>
        `;
      }, 15000);

      // Privacy bar
      initPrivacyBar();

      // Sign In and Connect use inline onclick handlers
      // Close more menu on Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const menu = document.getElementById('moreMenu');
          if (!menu.classList.contains('hidden')) toggleMoreMenu();
        }
      });
      
      // Homework event listeners are attached dynamically in loadHomework()

      document.getElementById('termsLink').addEventListener('click', function(e) {
        e.preventDefault();
        createModal('Terms of Use', `
          <p>Alo is a conversational companion, not a replacement for professional mental health care.</p>
          <p style="margin-top: 12px;"><strong>By using Alo, you agree that:</strong></p>
          <ul class="modal-list">
            <li>Alo does not provide medical advice, diagnosis, or treatment</li>
            <li>You will seek professional help for mental health crises</li>
            <li>Your therapist does not see your conversations with Alo</li>
            <li>You are responsible for deciding what to share with your therapist</li>
          </ul>
          <p class="modal-divider">
            If you're in crisis, call <strong>988</strong> (US Suicide & Crisis Lifeline) or go to your nearest emergency room.
          </p>
        `, {
          confirmLabel: 'I understand',
          showCancel: false
        });
      });

      document.getElementById('privacyLink').addEventListener('click', function(e) {
        e.preventDefault();
        createModal('Privacy Policy', `
          <h3 class="modal-section-title">What we store</h3>
          <ul class="modal-list">
            <li>Account information (email, password hash)</li>
            <li>Connection to your therapist</li>
            <li>Homework completion status</li>
            <li>Messages you send to your therapist</li>
          </ul>

          <h3 class="modal-section-title">Your Alo conversations</h3>
          <ul class="modal-list">
            <li>If you have an account, conversations are saved so Alo can provide continuity</li>
            <li>You can delete any conversation at any time from the sidebar</li>
            <li>You can turn off memory in settings — Alo will treat each chat as new</li>
            <li>Guest conversations (no account) are not stored permanently</li>
            <li>Your therapist <strong>cannot access</strong> your Alo conversations</li>
            <li>Conversations are not used for training, analytics, or advertising</li>
          </ul>

          <h3 class="modal-section-title">Who sees your data</h3>
          <ul class="modal-list">
            <li>Your therapist sees homework status and messages you send them</li>
            <li>Your therapist <strong>never</strong> sees your Alo conversations</li>
            <li>We don't sell or share your data with third parties</li>
          </ul>

          <h3 class="modal-section-title">Security</h3>
          <ul class="modal-list">
            <li>All stored data is encrypted at rest (AES-256) and in transit (TLS)</li>
            <li>Chat data is encrypted at rest and in transit by our chat provider</li>
            <li>Database access is controlled by row-level security — your therapist can only see their own clients</li>
          </ul>

          <p class="modal-divider">
            Questions about your privacy? Ask your therapist.
          </p>
        `, {
          confirmLabel: 'Got it',
          showCancel: false
        });
      });

      // Listen for auth state changes
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN') {
          loadConnectedState();
        } else if (event === 'SIGNED_OUT') {
          resetPersistenceState();
          authBridgeSent = false;
          resetToGuestUI();
        } else if (event === 'TOKEN_REFRESHED') {
          console.log('[Auth] Token refreshed');
        }
      });

      // Check for existing session
      const { data: { session } } = await supabase.auth.getSession();

      if (session) {
        await loadConnectedState();
      }
    });
  </script>
</body>
</html>
