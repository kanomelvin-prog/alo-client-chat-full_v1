<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <!-- FIXED: Removed user-scalable=no and maximum-scale for accessibility -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Alo" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#f6f3ee" />
  
  <title>Alo ‚Äî Companion for Emotional Clarity</title>
  <style>
    :root { 
      color-scheme: light;
      --warm-bg: #f6f3ee;
      --text-primary: #1f1f1f;
      --text-secondary: #595959; /* FIXED: Was rgba(31,31,31,0.7) - now meets WCAG 4.5:1 */
      --border-subtle: rgba(0, 0, 0, 0.08);
      --border-visible: rgba(0, 0, 0, 0.4); /* FIXED: Increased from 0.2 for better affordance */
    }
    
    * {
      box-sizing: border-box;
    }
    
    /* FIXED: Removed height: 100% from html, using 100dvh approach */
    html {
      height: 100dvh; /* Dynamic viewport height for mobile */
    }
    
    body {
      margin: 0;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background: var(--warm-bg);
      color: var(--text-primary);
      height: 100dvh; /* FIXED: Dynamic viewport height */
      overflow: hidden;
      display: flex;
      flex-direction: column;
      /* REMOVED: forceReflow animation - was causing jank */
    }
    
    /* ADDED: Reduced motion support for accessibility */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
    
    header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      padding-top: max(16px, env(safe-area-inset-top));
      padding-left: max(20px, env(safe-area-inset-left));
      padding-right: max(20px, env(safe-area-inset-right));
      background: rgba(246, 243, 238, 0.98);
      border-bottom: 1px solid var(--border-subtle);
      position: relative;
      z-index: 10;
    }
    
    .brand strong {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .brand span {
      font-size: 13px;
      color: var(--text-secondary);
      display: block;
      margin-top: 2px;
    }
    
    button {
      border: 1px solid var(--border-visible); /* FIXED: More visible border */
      background: #fff;
      padding: 9px 16px;
      min-height: 44px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* ADDED: Better affordance */
    }
    
    button:hover {
      background: #f8f8f8;
    }
    
    button:active {
      transform: scale(0.98);
      background: #f0f0f0;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    main {
      flex: 1;
      min-height: 0; /* FIXED: Important for flex children with overflow */
      overflow: hidden;
      position: relative;
      /* REMOVED: padding-bottom - let natural flex handle keyboard */
      /* REMOVED: All padding-bottom hacks (was 80px/120px/150px) */
      /* REMOVED: transform: translateZ(0) - was causing blur */
      /* REMOVED: will-change: transform */
    }
    
    /* ADDED: Loading overlay */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--warm-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    
    .loading-message {
      text-align: center;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-top-color: var(--text-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @media (prefers-reduced-motion: reduce) {
      .spinner {
        animation: none;
        border-top-color: transparent;
        border-right-color: var(--text-primary);
      }
    }
    
    .error-message {
      text-align: center;
      padding: 20px;
    }
    
    .error-message button {
      margin-top: 16px;
    }
    
    iframe {
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
      background: #fff;
      /* REMOVED: transform: translateZ(0) - was causing issues */
    }
    
    footer {
      flex-shrink: 0;
      padding: 12px 20px;
      padding-left: max(20px, env(safe-area-inset-left));
      padding-right: max(20px, env(safe-area-inset-right));
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      font-size: 11px;
      color: var(--text-secondary);
      background: rgba(246, 243, 238, 0.98);
      border-top: 1px solid var(--border-subtle);
      text-align: center;
      position: relative;
      z-index: 10;
      opacity: 0.7; /* FIXED: Quieter, less anxiety-inducing */
    }
    
    footer a {
      color: var(--text-primary);
      font-weight: 600;
      text-decoration: none;
      border-bottom: 1px solid currentColor;
    }
    
    /* Modal styles - FIXED: Added accessibility attributes */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-height: 80vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
      position: relative;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-content h3 {
      margin-top: 0;
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--text-primary);
    }
    
    .modal-content p {
      margin: 12px 0;
      line-height: 1.6;
      font-size: 15px;
      color: var(--text-primary);
    }
    
    .modal-content ol,
    .modal-content ul {
      margin: 16px 0;
      padding-left: 24px;
    }
    
    .modal-content li {
      margin: 8px 0;
      line-height: 1.5;
    }
    
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 24px;
      line-height: 1;
      padding: 4px 8px;
      min-height: 32px;
      cursor: pointer;
      color: var(--text-secondary);
      box-shadow: none;
    }
    
    .modal-close:hover {
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.05);
    }
    
    /* ADDED: Copy box for Share Summary */
    .copy-box {
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin: 16px 0;
    }
    
    .copy-box textarea {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      margin-bottom: 8px;
    }
    
    .copy-box button {
      width: 100%;
    }
    
    .privacy-note {
      font-size: 13px;
      color: var(--text-secondary);
      background: #f9f9f9;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid var(--text-primary);
      margin: 16px 0;
    }
    
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    
    .button-group button {
      flex: 1;
    }
    
    .btn-primary {
      background: #0176ff;
      color: white;
      border-color: #0176ff;
    }
    
    .btn-primary:hover {
      background: #0156cc;
    }
    
    .btn-primary:active {
      background: #0146aa;
    }
    
    .btn-secondary {
      background: transparent;
      color: var(--text-primary);
    }
    
    /* Mobile adjustments - REMOVED: padding hacks */
    @media (max-width: 640px) {
      header {
        padding: 12px 16px;
        padding-top: max(12px, env(safe-area-inset-top));
      }
      
      .brand strong { font-size: 14px; }
      .brand span { font-size: 12px; }
      
      button {
        padding: 8px 12px;
        font-size: 13px;
      }
      
      footer {
        font-size: 11px;
        padding: 10px 16px;
        padding-bottom: max(10px, env(safe-area-inset-bottom));
      }
      
      /* REMOVED: Extra bottom padding on main - was creating white space */
    }
    
    @media (max-width: 400px) {
      .brand span { display: none; }
      button { 
        padding: 8px 10px; 
        font-size: 12px;
      }
      
      header > div:last-child {
        flex-direction: column;
        gap: 6px !important;
      }
      
      button {
        width: 100%;
        min-width: 80px;
      }
    }
    
    /* REMOVED: Keyboard detection media query - was causing issues */
  </style>
</head>

<body>
  <header>
    <div class="brand">
      <strong>Alo</strong>
      <span>A companion for emotional clarity</span>
    </div>
    <div style="display: flex; gap: 8px;">
      <button id="shareChat">Share</button>
      <button id="startFresh">Start Fresh</button>
    </div>
  </header>

  <main id="chatMain">
    <!-- ADDED: Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-message">
        <div class="spinner"></div>
        <p>Loading Alo...</p>
      </div>
    </div>
    
    <iframe
      id="aloFrame"
      src="https://cdn.botpress.cloud/webchat/v3.5/shareable.html?configUrl=https://files.bpcontent.cloud/2026/02/04/21/20260204212451-JLWZS8SU.json"
      allow="clipboard-read; clipboard-write"
      sandbox="allow-scripts allow-forms allow-popups allow-modals allow-same-origin"
      referrerpolicy="no-referrer"
      title="Alo Chat Interface"
      aria-label="Chatbot Conversation Window"
    >
      <!-- ADDED: Fallback content if iframe fails -->
      <div style="padding: 20px; text-align: center;">
        <p>Unable to load chat interface.</p>
        <p>If you are in crisis, please call <a href="tel:988">988</a> (US).</p>
      </div>
    </iframe>
  </main>

  <footer>
    Need support? <a href="tel:988">988</a> (US) ¬∑ <a href="#safety" onclick="showSafetyResources(event); return false;">Other resources</a>
  </footer>

  <script>
    // ADDED: Loading state management
    const iframe = document.getElementById('aloFrame');
    const loadingOverlay = document.getElementById('loadingOverlay');
    let loadTimeout;
    
    // Hide loading on successful load
    iframe.addEventListener('load', function() {
      loadingOverlay.style.display = 'none';
      clearTimeout(loadTimeout);
      
      // ADDED: iOS Safari viewport fix
      // Issue: On initial load, iOS doesn't calculate viewport correctly
      // Symptom: Footer gets cut off, everything stacks poorly
      // Fix: When user taps out then back in, iOS recalculates and fixes it
      // Solution: Trigger the same recalculation automatically on load
      setTimeout(function() {
        // Force iOS to recalculate viewport by triggering resize events
        window.dispatchEvent(new Event('resize'));
        
        // Small padding nudge to trigger reflow (mimics keyboard appearing/disappearing)
        const main = document.getElementById('chatMain');
        const originalHeight = main.style.height;
        main.style.height = 'calc(100% - 1px)';
        
        setTimeout(function() {
          main.style.height = originalHeight;
          window.dispatchEvent(new Event('resize'));
        }, 50);
      }, 200);
    });
    
    // Show error if timeout (10 seconds)
    loadTimeout = setTimeout(function() {
      loadingOverlay.innerHTML = `
        <div class="error-message">
          <p><strong>Having trouble loading Alo</strong></p>
          <p>Please check your connection and try again.</p>
          <button onclick="location.reload()">Retry</button>
          <p style="font-size: 13px; margin-top: 20px; color: var(--text-secondary);">
            If you're in crisis, call <a href="tel:988" style="color: var(--text-primary);">988</a>
          </p>
        </div>
      `;
    }, 10000);
    
    // Utility: Close modal and return focus
    function closeModal(modal, returnFocusTo) {
      if (modal && modal.parentNode) {
        modal.remove();
      }
      if (returnFocusTo) {
        returnFocusTo.focus();
      }
    }
    
    // Utility: Copy to clipboard
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textArea);
        return success;
      }
    }
    
    // ADDED: Safety Resources modal
    function showSafetyResources(event) {
      if (event) event.preventDefault();
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.setAttribute('role', 'dialog');
      modal.setAttribute('aria-modal', 'true');
      modal.setAttribute('aria-label', 'Safety Resources');
      modal.setAttribute('tabindex', '-1');
      
      const content = document.createElement('div');
      content.className = 'modal-content';
      content.innerHTML = `
        <button class="modal-close" aria-label="Close">&times;</button>
        <h3>Safety Resources</h3>
        
        <p><strong>If you're in immediate danger:</strong></p>
        <ul>
          <li><strong>United States:</strong> Call or text <a href="tel:988">988</a> (Suicide & Crisis Lifeline)</li>
          <li><strong>United Kingdom:</strong> Call 116 123 (Samaritans)</li>
          <li><strong>Canada:</strong> Call 1-833-456-4566 (Talk Suicide Canada)</li>
          <li><strong>Australia:</strong> Call 13 11 14 (Lifeline)</li>
          <li><strong>International:</strong> Visit <a href="https://findahelpline.com" target="_blank" rel="noopener">findahelpline.com</a></li>
        </ul>
        
        <div class="privacy-note">
          <strong>About Alo:</strong> Alo is a support tool to help you process emotions between therapy sessions. 
          It is not a therapist, crisis service, or medical provider. If you're experiencing a mental health 
          emergency, please use the resources above.
        </div>
        
        <button onclick="closeModal(this.closest('.modal-overlay'))">Close</button>
      `;
      
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // FIXED: Focus management for accessibility
      modal.focus();
      
      // Close on overlay click (but not content click)
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal(modal);
        }
      });
      
      // Close on ESC key
      modal.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal(modal);
        }
      });
      
      // Close button handler
      content.querySelector('.modal-close').addEventListener('click', function() {
        closeModal(modal);
      });
    }
    
    // REDESIGNED: Share with "Share Summary" approach
    document.getElementById('shareChat').addEventListener('click', async function() {
      const btn = this;
      const originalText = btn.textContent;
      
      // Disable button during operation
      btn.disabled = true;
      btn.textContent = 'Opening...';
      
      // Small delay for button feedback
      setTimeout(function() {
        btn.textContent = originalText;
        btn.disabled = false;
        showShareOptions(btn);
      }, 200);
    });
    
    function showShareOptions(triggerButton) {
      const summaryPrompt = `Alo, please create a 5-bullet summary of our conversation for me to share with my therapist or someone I trust. Include key insights and one suggested next step.`;
      const fullPrompt = `Alo, please provide a complete transcript of our entire conversation in a clean, readable format that I can share.`;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.setAttribute('role', 'dialog');
      modal.setAttribute('aria-modal', 'true');
      modal.setAttribute('aria-label', 'Share Your Conversation');
      modal.setAttribute('tabindex', '-1');
      
      const content = document.createElement('div');
      content.className = 'modal-content';
      content.innerHTML = `
        <button class="modal-close" aria-label="Close">&times;</button>
        <h3>Share Your Conversation</h3>
        
        <!-- 3 Quick Options at Top -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0;">
          <button id="optionSummary" style="padding: 16px 12px; flex-direction: column; display: flex; align-items: center; gap: 8px; background: #f0f9ff; border-color: #0ea5e9;">
            <span style="font-size: 24px;">üìù</span>
            <span style="font-size: 13px; font-weight: 600;">Summary</span>
          </button>
          <button id="optionFull" style="padding: 16px 12px; flex-direction: column; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 24px;">üìÑ</span>
            <span style="font-size: 13px; font-weight: 600;">Full</span>
          </button>
          <button id="optionRange" style="padding: 16px 12px; flex-direction: column; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 24px;">üéØ</span>
            <span style="font-size: 13px; font-weight: 600;">Range</span>
          </button>
        </div>
        
        <!-- Instructions Area (changes based on selection) -->
        <div id="instructionsArea">
          <!-- Summary Instructions (default) -->
          <div id="summaryInstructions">
            <p style="font-size: 14px; margin: 12px 0 8px 0; color: var(--text-secondary);">
              Get a 5-bullet summary perfect for sharing with your therapist
            </p>
            <ol style="font-size: 14px; line-height: 1.5; margin: 12px 0;">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates a summary</li>
              <li>Long-press to copy & share</li>
            </ol>
            <div class="copy-box">
              <textarea readonly id="summaryPromptText" style="min-height: 80px; font-size: 13px;">${summaryPrompt}</textarea>
              <button id="copySummaryBtn" class="btn-primary">üìã Copy Message</button>
            </div>
          </div>
          
          <!-- Full Conversation Instructions (hidden) -->
          <div id="fullInstructions" style="display: none;">
            <p style="font-size: 14px; margin: 12px 0 8px 0; color: var(--text-secondary);">
              Get a complete transcript of everything discussed
            </p>
            <ol style="font-size: 14px; line-height: 1.5; margin: 12px 0;">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates full transcript</li>
              <li>Long-press to copy & share</li>
            </ol>
            <div class="copy-box">
              <textarea readonly id="fullPromptText" style="min-height: 80px; font-size: 13px;">${fullPrompt}</textarea>
              <button id="copyFullBtn" class="btn-primary" style="background: #6366f1; border-color: #6366f1;">üìã Copy Message</button>
            </div>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
              üí° Full transcripts are long‚Äîsummary is usually better for sharing
            </p>
          </div>
          
          <!-- Range Instructions (hidden) -->
          <div id="rangeInstructions" style="display: none;">
            <p style="font-size: 14px; margin: 12px 0 8px 0; color: var(--text-secondary);">
              Share specific parts (example: turns 3-8)
            </p>
            <div style="display: flex; gap: 12px; margin: 16px 0;">
              <div style="flex: 1;">
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Start:</label>
                <input type="number" id="rangeStart" min="1" value="1" 
                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
              </div>
              <div style="flex: 1;">
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">End:</label>
                <input type="number" id="rangeEnd" min="1" value="10" 
                  style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px;">
              </div>
            </div>
            <button id="copyRangeBtn" class="btn-primary" style="width: 100%; background: #8b5cf6; border-color: #8b5cf6;">
              üìã Copy Range Message
            </button>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
              üí° Count message bubbles to find turn numbers
            </p>
          </div>
        </div>
        
        <div class="privacy-note" style="font-size: 12px; margin-top: 16px;">
          <strong>How to share:</strong> After Alo creates your summary/transcript, long-press on it and select "Copy". Then paste into Messages, Email, or Notes.
        </div>
        
        <div class="button-group" style="margin-top: 20px;">
          <button onclick="closeModal(this.closest('.modal-overlay'), document.getElementById('shareChat'))">
            Close
          </button>
        </div>
      `;
      
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // FIXED: Focus management for accessibility
      modal.focus();
      
      // Tab switching logic
      const optionSummary = content.querySelector('#optionSummary');
      const optionFull = content.querySelector('#optionFull');
      const optionRange = content.querySelector('#optionRange');
      
      const summaryInstructions = content.querySelector('#summaryInstructions');
      const fullInstructions = content.querySelector('#fullInstructions');
      const rangeInstructions = content.querySelector('#rangeInstructions');
      
      function switchTab(tab) {
        // Reset all buttons
        [optionSummary, optionFull, optionRange].forEach(btn => {
          btn.style.background = '#fff';
          btn.style.borderColor = 'var(--border-visible)';
        });
        
        // Hide all instructions
        summaryInstructions.style.display = 'none';
        fullInstructions.style.display = 'none';
        rangeInstructions.style.display = 'none';
        
        // Show selected tab
        if (tab === 'summary') {
          optionSummary.style.background = '#f0f9ff';
          optionSummary.style.borderColor = '#0ea5e9';
          summaryInstructions.style.display = 'block';
        } else if (tab === 'full') {
          optionFull.style.background = '#f0f9ff';
          optionFull.style.borderColor = '#0ea5e9';
          fullInstructions.style.display = 'block';
        } else if (tab === 'range') {
          optionRange.style.background = '#f0f9ff';
          optionRange.style.borderColor = '#0ea5e9';
          rangeInstructions.style.display = 'block';
        }
      }
      
      // Tab click handlers
      optionSummary.addEventListener('click', () => switchTab('summary'));
      optionFull.addEventListener('click', () => switchTab('full'));
      optionRange.addEventListener('click', () => switchTab('range'));
      
      // Copy button handlers
      const copySummaryBtn = content.querySelector('#copySummaryBtn');
      const copyFullBtn = content.querySelector('#copyFullBtn');
      const copyRangeBtn = content.querySelector('#copyRangeBtn');
      
      // Summary copy
      copySummaryBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(summaryPrompt);
        if (success) {
          copySummaryBtn.textContent = '‚úì Copied!';
          copySummaryBtn.style.background = '#10b981';
          setTimeout(function() {
            copySummaryBtn.textContent = 'üìã Copy Message';
            copySummaryBtn.style.background = '';
          }, 2000);
        } else {
          copySummaryBtn.textContent = 'Copy Failed';
          setTimeout(function() {
            copySummaryBtn.textContent = 'üìã Copy Message';
          }, 2000);
        }
      });
      
      // Full copy
      copyFullBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(fullPrompt);
        if (success) {
          copyFullBtn.textContent = '‚úì Copied!';
          copyFullBtn.style.background = '#10b981';
          setTimeout(function() {
            copyFullBtn.textContent = 'üìã Copy Message';
            copyFullBtn.style.background = '#6366f1';
          }, 2000);
        } else {
          copyFullBtn.textContent = 'Copy Failed';
          setTimeout(function() {
            copyFullBtn.textContent = 'üìã Copy Message';
          }, 2000);
        }
      });
      
      // Range copy
      copyRangeBtn.addEventListener('click', async function() {
        const startTurn = content.querySelector('#rangeStart').value;
        const endTurn = content.querySelector('#rangeEnd').value;
        const rangePrompt = `Alo, please provide turns ${startTurn} through ${endTurn} of our conversation in a clean, readable format that I can share.`;
        
        const success = await copyToClipboard(rangePrompt);
        if (success) {
          copyRangeBtn.textContent = '‚úì Copied!';
          copyRangeBtn.style.background = '#10b981';
          setTimeout(function() {
            copyRangeBtn.textContent = 'üìã Copy Range Message';
            copyRangeBtn.style.background = '#8b5cf6';
          }, 2000);
        } else {
          copyRangeBtn.textContent = 'Copy Failed';
          setTimeout(function() {
            copyRangeBtn.textContent = 'üìã Copy Range Message';
          }, 2000);
        }
      });
      
      // Close on overlay click (but not content click)
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeModal(modal, triggerButton);
        }
      });
      
      // Close on ESC key
      modal.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeModal(modal, triggerButton);
        }
      });
      
      // Close button handler
      content.querySelector('.modal-close').addEventListener('click', function() {
        closeModal(modal, triggerButton);
      });
    }
    
    // FIXED: Start Fresh - Force new conversation with cache-busting
    document.getElementById('startFresh').addEventListener('click', function() {
      // ADDED: Confirmation dialog with gentle copy
      const message = 
        'Start a new conversation?\n\n' +
        'This will clear your current chat in this browser. ' +
        'If you want to keep anything, share a summary first.';
      
      const confirmed = confirm(message);
      
      if (!confirmed) {
        return; // User cancelled
      }
      
      // Clear all Botpress data
      try {
        const keys = Object.keys(localStorage);
        keys.forEach(key => {
          if (key.toLowerCase().includes('botpress') || 
              key.toLowerCase().includes('bp') || 
              key.toLowerCase().includes('webchat')) {
            localStorage.removeItem(key);
          }
        });
        sessionStorage.clear();
      } catch (e) {
        console.log('‚ö†Ô∏è Could not clear storage:', e);
      }
      
      // Force reload with cache-busting parameter to ensure fresh start
      const timestamp = new Date().getTime();
      window.location.href = window.location.pathname + '?refresh=' + timestamp;
    });
    
    // REMOVED: Manual reflow animation on page load - was causing jank
  </script>
</body>
</html>
