<!DOCTYPE html>
<!-- ALO CLIENT CHAT v2.2 ‚Äî Feb 19, 2026 ‚Äî 11-persona review fixes -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Alo" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#FDFBF7" />
  
  <!-- Open Graph ‚Äî link preview when therapist texts URL to client -->
  <meta property="og:title" content="Alo ‚Äî Someone to think out loud with" />
  <meta property="og:description" content="A private space to process your thoughts and emotions. Your therapist recommended Alo as a companion between sessions." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://kanomelvin-prog.github.io/alo-client-chat-full_v1/" />
  <meta property="og:image" content="https://kanomelvin-prog.github.io/alo-client-chat-full_v1/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="description" content="Alo is a private emotional support companion. Process thoughts between therapy sessions with Socratic questioning." />
  
  <title>Alo ‚Äî Someone to think out loud with</title>
      <link rel="stylesheet" href="styles.css">

</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-icon">A</div>
      <div class="brand-text">
        <h1 class="brand-name">Alo</h1>
        <span>Someone to think out loud with</span>
        <div id="trustBadge" class="trust-badge guest">
          <span id="trustBadgeText"></span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button id="connectBtn" class="btn-primary">Connect</button>
      <button id="privacyBtn" class="hidden">My Privacy</button>
      <button id="messageBtn" class="hidden">Message</button>
      <button id="shareChat">Share</button>
            

    </div>
  </header>

  <main id="chatMain">
    <!-- Homework card (hidden unless client has active homework) -->
    <div id="homeworkContainer" class="homework-container">
      <div class="homework-card">
        <div class="homework-header">
          <div class="homework-title" id="homeworkTitle">From your therapist</div>
          <button class="homework-collapse" id="homeworkCollapseBtn" 
            aria-label="Toggle homework" 
            aria-controls="homeworkBody" 
            aria-expanded="true">‚àí</button>
        </div>
        <div class="homework-body" id="homeworkBody">
          <p id="homeworkGoal"></p>
          <div class="homework-actions">
            <button class="btn-primary" id="homeworkDoneBtn">‚úì I did this</button>
            <button class="btn-link" id="homeworkHideBtn">Hide for now</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat iframe -->
    <div class="chat-container">
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-message">
          <div class="spinner"></div>
          <p>Loading Alo...</p>
        </div>
      </div>
      
      <iframe
        id="aloFrame"
        src="https://cdn.botpress.cloud/webchat/v3.5/shareable.html?configUrl=https://files.bpcontent.cloud/2026/02/06/16/20260206160131-TJR3ODT9.json"
        allow="clipboard-read; clipboard-write"
        title="Alo Chat Interface"
        aria-label="Chatbot Conversation Window"
      >


        <div style="padding: 20px; text-align: center;">
          <p>Unable to load chat interface.</p>
          <p>If you need help now, call <a href="tel:988">988</a> (US).</p>
        </div>
      </iframe>
    </div>
  </main>

  <footer>
    Alo helps you think ‚Äî not a therapist or doctor. ¬∑ 
    Need help now? <a href="tel:988">988</a> (US) ¬∑ <a href="#safety" onclick="showSafetyResources(event); return false;">Other resources</a>
    <br><a href="#terms" onclick="showTermsModal(event); return false;">Terms</a> ¬∑ <a href="#privacy" onclick="showPrivacyModal2(event); return false;">Privacy Policy</a>
  </footer>

  <!-- Toast container -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <script>
    // =====================================================
    // CONFIG
    // =====================================================
    const SUPABASE_URL = 'https://lelsdezstbnzyxvsvbyx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlbHNkZXpzdGJuenl4dnN2Ynl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDk1NDUsImV4cCI6MjA3OTE4NTU0NX0.mm1POxfEEoRXyTF08NsUZOau6qA_UdZJnoUH_5bkQas';

    let clientSession = null;
    let clientId = null;
    let therapistLink = null;
    let chatSettings = null;
    let activeHomework = null;

    // =====================================================
    // SUPABASE API HELPER
    // =====================================================
    async function api(endpoint, options = {}) {
      const token = clientSession?.access_token || SUPABASE_ANON_KEY;
      const res = await fetch(`${SUPABASE_URL}${endpoint}`, {
        ...options,
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
          'Prefer': options.prefer || 'return=representation',
          ...options.headers
        }
      });
      if (!res.ok) {
        const body = await res.text();
        throw new Error(`API ${res.status}: ${body}`);
      }
      const text = await res.text();
      return text ? JSON.parse(text) : null;
    }

    // =====================================================
    // TOAST NOTIFICATIONS (replaces alert())
    // =====================================================
    function showToast(message, type = 'default', duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast' + (type === 'success' ? ' success' : '');
      
      // Force reflow then show
      toast.offsetHeight;
      toast.classList.add('show');
      
      setTimeout(function() {
        toast.classList.remove('show');
      }, duration);
    }

    // =====================================================
    // CONFIRM MODAL (replaces confirm())
    // =====================================================
    function showConfirm(title, message, confirmLabel, onConfirm, options = {}) {
      const isDanger = options.danger || false;
      const cancelLabel = options.cancelLabel || 'Cancel';
      
      const modal = createModal(title, `
        <p>${message}</p>
        <div class="button-group">
          <button class="btn-secondary" data-action="cancel">${esc(cancelLabel)}</button>
          <button class="${isDanger ? 'btn-danger-outline' : 'btn-primary'}" data-action="confirm">${esc(confirmLabel)}</button>
        </div>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      modal.querySelector('[data-action="cancel"]').addEventListener('click', function() {
        closeModal(modal);
      });
      
      modal.querySelector('[data-action="confirm"]').addEventListener('click', function() {
        closeModal(modal);
        onConfirm();
      });
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
            document.addEventListener('DOMContentLoaded', async () => {
      setupEventListeners();
      
      try {
        const stored = localStorage.getItem('alo_client_session');
        if (stored) {
          const parsed = JSON.parse(stored);
          const refreshed = await refreshSession(parsed.refresh_token);
          if (refreshed) {
            clientSession = refreshed;
            clientId = refreshed.user.id;
            localStorage.setItem('alo_client_session', JSON.stringify(refreshed));
            await loadConnectedState();
          }
        }
      } catch (e) {
        console.log('No valid client session, running in guest mode');
      }
    });



    async function refreshSession(refreshToken) {
      try {
        const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=refresh_token`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ refresh_token: refreshToken })
        });
        if (!res.ok) return null;
        return await res.json();
      } catch { return null; }
    }

    async function loadConnectedState() {
      try {
        const links = await api(`/rest/v1/therapist_clients?client_id=eq.${clientId}&status=eq.active&select=*`);
        if (!links?.length) {
          showLoggedInNoConnection();
          return;
        }
        
        therapistLink = links[0];
        
        const therapists = await api(`/rest/v1/profiles?id=eq.${therapistLink.therapist_id}&select=display_name`);
        const therapistName = therapists?.[0]?.display_name || 'Your Therapist';
        
        const clientProfiles = await api(`/rest/v1/profiles?id=eq.${clientId}&select=display_name,email`);
        const clientName = clientProfiles?.[0]?.display_name || clientProfiles?.[0]?.email?.split('@')[0] || 'there';
        
        const settings = await api(`/rest/v1/client_chat_settings?therapist_client_id=eq.${therapistLink.id}`);
        chatSettings = settings?.[0] || {
          homework_visibility: true,
          messaging_enabled: true,
          summary_sharing_enabled: true,
          conversation_history_enabled: true
        };
        
        showConnectedUI(therapistName, clientName);
        
        if (chatSettings.homework_visibility) {
          await loadHomework();
        }
        
      } catch (err) {
        console.error('Error loading connected state:', err);
      }
    }

    function showLoggedInNoConnection() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge';
      badgeText.textContent = 'Logged in';
      badge.style.display = 'flex';
      document.getElementById('connectBtn').classList.remove('hidden');
    }

    function showConnectedUI(therapistName, clientName) {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      
      badge.className = 'trust-badge connected';
      
      if (!badge.querySelector('svg')) {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');
        svg.style.width = '12px';
        svg.style.height = '12px';
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('d', 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z');
        
        svg.appendChild(path);
        badge.insertBefore(svg, badgeText);
      }
      
      badgeText.textContent = `Hi ${clientName} ¬∑ with ${therapistName}`;
      
      document.getElementById('connectBtn').classList.add('hidden');
      document.getElementById('privacyBtn').classList.remove('hidden');
      
      if (chatSettings.messaging_enabled) {
        document.getElementById('messageBtn').classList.remove('hidden');
      }
    }

    async function loadHomework() {
      try {
        const homework = await api(`/rest/v1/homework_cards?client_id=eq.${clientId}&is_active=eq.true&order=created_at.desc&limit=1`);
        if (homework?.length) {
          activeHomework = homework[0];
          document.getElementById('homeworkTitle').textContent = activeHomework.title || 'From your therapist';
          document.getElementById('homeworkGoal').textContent = activeHomework.goal;
          document.getElementById('homeworkContainer').classList.add('show');
        }
      } catch (err) {
        console.error('Error loading homework:', err);
      }
    }

    // =====================================================
    // EVENT LISTENERS
    // =====================================================
    function setupEventListeners() {
      const iframe = document.getElementById('aloFrame');
      const loadingOverlay = document.getElementById('loadingOverlay');
      let loadTimeout;
      
      // Clean iframe load ‚Äî no viewport hacks
      iframe.addEventListener('load', function() {
        loadingOverlay.style.display = 'none';
        clearTimeout(loadTimeout);
      });
      
      loadTimeout = setTimeout(function() {
        loadingOverlay.innerHTML = `
          <div class="error-message">
            <p><strong>Still loading...</strong></p>
            <p>This is taking longer than usual. Let's try again.</p>
            <button onclick="location.reload()">Retry</button>
            <p style="font-size: 13px; margin-top: 20px; color: var(--text-secondary);">
              Need help now? Call <a href="tel:988" style="color: var(--text-primary);">988</a>
            </p>
          </div>
        `;
      }, 15000);
      
      document.getElementById('connectBtn').addEventListener('click', showConnectModal);
      document.getElementById('privacyBtn').addEventListener('click', showPrivacyModal);
      document.getElementById('messageBtn').addEventListener('click', showMessageModal);
      document.getElementById('shareChat').addEventListener('click', showShareModal);
      
      document.getElementById('homeworkDoneBtn').addEventListener('click', handleHomeworkDone);
      
      document.getElementById('homeworkCollapseBtn').addEventListener('click', function() {
        const body = document.getElementById('homeworkBody');
        const btn = this;
        const isCollapsed = body.classList.contains('collapsed');
        body.classList.toggle('collapsed');
        btn.textContent = isCollapsed ? '‚àí' : '+';
        btn.setAttribute('aria-expanded', isCollapsed ? 'true' : 'false');
      });
      
      document.getElementById('homeworkHideBtn').addEventListener('click', function() {
        document.getElementById('homeworkContainer').classList.remove('show');
        localStorage.setItem('alo_homework_hidden', 'true');
      });
    }

    // =====================================================
    // START FRESH
    // =====================================================
    function handleStartFresh() {
      showConfirm(
        'Start a new conversation?',
        'This will clear your current chat. If you want to keep anything, use Share to save a summary first.',
        'Start Fresh',
        function() {
          const iframe = document.getElementById('aloFrame');
          const src = iframe.src;
          
          // Clear Botpress storage
          try {
            const keys = Object.keys(localStorage);
            keys.forEach(function(key) {
              if (key.toLowerCase().includes('botpress') || 
                  key.toLowerCase().includes('bp') || 
                  key.toLowerCase().includes('webchat')) {
                localStorage.removeItem(key);
              }
            });
            sessionStorage.clear();
          } catch (e) {
            console.log('Could not clear storage:', e);
          }
          
          // Recreate iframe
          const loadingOverlay = document.getElementById('loadingOverlay');
          loadingOverlay.style.display = 'flex';
          loadingOverlay.innerHTML = `
            <div class="loading-message">
              <div class="spinner"></div>
              <p>Starting fresh...</p>
            </div>
          `;
          
          iframe.src = '';
          setTimeout(function() {
            iframe.src = src + '&t=' + Date.now();
          }, 100);
          
          showToast('New conversation started', 'success');
        },
        { cancelLabel: 'Keep chatting' }
      );
    }

    // =====================================================
    // CONNECT MODAL
    // =====================================================
    function showConnectModal() {
      const modal = createModal('Connect to Your Therapist', `
        <p>Connecting lets your therapist send you exercises and lets you message them between sessions. <strong>They never see your conversations with Alo.</strong></p>
        <p style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">Enter the invite code your therapist gave you to link your account.</p>
        
        <div class="error-text" id="connectError"></div>
        
        <form id="authForm" onsubmit="handleConnect(); return false;">
          <div class="form-group">
            <label for="authEmail">Email</label>
            <input type="email" id="authEmail" placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="authPassword">Password</label>
            <input type="password" id="authPassword" placeholder="Min. 6 characters">
            <div class="form-hint">Create a password to save your connection</div>
          </div>
          <div class="form-group">
            <label for="inviteCode">Invite Code</label>
            <input type="text" id="inviteCode" placeholder="ALO-XXXX" style="text-transform: uppercase;">
            <div class="form-hint">Your therapist will give you this code</div>
          </div>
          
          <div class="button-group">
            <button type="button" class="btn-secondary" onclick="closeModal(this.closest('.modal-overlay'))">Cancel</button>
            <button type="submit" class="btn-primary">Connect</button>
          </div>
        </form>
        
        <p style="font-size: 11px; color: var(--text-muted); margin-top: 12px; text-align: center;">
          By creating an account, you agree to our <a href="#" onclick="showTermsModal(event); return false;" style="color: var(--sage);">Terms of Use</a> and <a href="#" onclick="showPrivacyModal2(event); return false;" style="color: var(--sage);">Privacy Policy</a>.
        </p>
        
        <p style="font-size: 13px; color: var(--text-secondary); margin-top: 16px; text-align: center;">
          Already have an account? <button class="btn-link" onclick="showLoginModal()">Sign in</button>
        </p>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
    }

    async function handleConnect() {
      const email = document.getElementById('authEmail').value.trim();
      const password = document.getElementById('authPassword').value;
      const code = document.getElementById('inviteCode').value.trim().toUpperCase();
      const errorEl = document.getElementById('connectError');
      
      errorEl.classList.remove('show');
      
      if (!email || !password || !code) {
        errorEl.textContent = 'Please fill in all fields';
        errorEl.classList.add('show');
        return;
      }
      
      if (password.length < 6) {
        errorEl.textContent = 'Password must be at least 6 characters';
        errorEl.classList.add('show');
        return;
      }
      
      try {
        const signupRes = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email,
            password,
            data: { role: 'client' }
          })
        });
        
        if (!signupRes.ok) {
          const body = await signupRes.json();
          throw new Error(body.error_description || body.msg || 'Signup failed');
        }
        
        const signupData = await signupRes.json();
        
        if (!signupData.access_token) {
          errorEl.textContent = 'Account created! Check your email for confirmation, then sign in.';
          errorEl.classList.add('show');
          return;
        }
        
        clientSession = signupData;
        clientId = clientSession.user.id;
        localStorage.setItem('alo_client_session', JSON.stringify(clientSession));
        
        await api('/rest/v1/profiles', {
          method: 'POST',
          body: JSON.stringify({
            id: clientId,
            role: 'client',
            email: email
          }),
          prefer: 'return=minimal'
        });
        
        const result = await api('/rest/v1/rpc/redeem_invite_code', {
          method: 'POST',
          body: JSON.stringify({
            p_code: code,
            p_client_id: clientId
          })
        });
        
        if (!result.success) {
          throw new Error(result.error || 'Invalid invite code');
        }
        
        await loadConnectedState();
        closeModal(document.querySelector('.modal-overlay'));
        
        showToast(`Connected to ${result.therapist_name} ‚úì`, 'success');
        
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.add('show');
      }
    }

    function showLoginModal() {
      closeModal(document.querySelector('.modal-overlay'));
      
      const modal = createModal('Sign In', `
        <div class="error-text" id="loginError"></div>
        
        <form onsubmit="handleLogin(); return false;">
          <div class="form-group">
            <label for="loginEmail">Email</label>
            <input type="email" id="loginEmail" placeholder="you@example.com">
          </div>
          <div class="form-group">
            <label for="loginPassword">Password</label>
            <input type="password" id="loginPassword" placeholder="Your password">
          </div>
          
          <div class="button-group">
            <button type="button" class="btn-secondary" onclick="closeModal(this.closest('.modal-overlay'))">Cancel</button>
            <button type="submit" class="btn-primary">Sign In</button>
          </div>
        </form>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
    }

    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      
      errorEl.classList.remove('show');
      
      if (!email || !password) {
        errorEl.textContent = 'Please enter email and password';
        errorEl.classList.add('show');
        return;
      }
      
      try {
        const res = await fetch(`${SUPABASE_URL}/auth/v1/token?grant_type=password`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        if (!res.ok) {
          const body = await res.json();
          throw new Error(body.error_description || body.msg || 'Login failed');
        }
        
        clientSession = await res.json();
        clientId = clientSession.user.id;
        localStorage.setItem('alo_client_session', JSON.stringify(clientSession));
        
        await loadConnectedState();
        closeModal(document.querySelector('.modal-overlay'));
        showToast('Signed in ‚úì', 'success');
        
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.add('show');
      }
    }

    // =====================================================
    // MESSAGE MODAL
    // =====================================================
    function showMessageModal() {
      const therapistName = therapistLink ? document.getElementById('trustBadgeText').textContent.split('with ')[1] : 'your therapist';
      
      const modal = createModal('Message Your Therapist', `
        <p>Send a message to ${esc(therapistName)}. They'll see it in their dashboard.</p>
        
        <div class="privacy-note">
          <strong>Privacy:</strong> This message is separate from your Alo conversations. Your therapist never sees your chat.
        </div>
        
        <div class="error-text" id="messageError"></div>
        
        <form onsubmit="handleSendMessage(); return false;">
          <div class="form-group">
            <label for="messageText">Your message</label>
            <textarea id="messageText" placeholder="What would you like to share with your therapist?"></textarea>
          </div>
          
          <div class="button-group">
            <button type="button" class="btn-secondary" onclick="closeModal(this.closest('.modal-overlay'))">Cancel</button>
            <button type="submit" class="btn-primary">Send Message</button>
          </div>
        </form>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
    }

    async function handleSendMessage() {
      const text = document.getElementById('messageText').value.trim();
      const errorEl = document.getElementById('messageError');
      
      errorEl.classList.remove('show');
      
      if (!text) {
        errorEl.textContent = 'Please enter a message';
        errorEl.classList.add('show');
        return;
      }
      
      try {
        await api('/rest/v1/client_messages', {
          method: 'POST',
          body: JSON.stringify({
            client_id: clientId,
            therapist_client_id: therapistLink.id,
            message: text
          }),
          prefer: 'return=minimal'
        });
        
        closeModal(document.querySelector('.modal-overlay'));
        const therapistName = document.getElementById('trustBadgeText').textContent.split('with ')[1] || 'your therapist';
        showToast(`Sent to ${therapistName} ‚úì`, 'success');
        
      } catch (err) {
        errorEl.textContent = 'Failed to send message. Please try again.';
        errorEl.classList.add('show');
      }
    }

    // =====================================================
    // PRIVACY MODAL
    // =====================================================
    function showPrivacyModal() {
      const therapistName = document.getElementById('trustBadgeText').textContent.split('with ')[1] || 'your therapist';
      
      const modal = createModal('My Privacy', `
        <p>You control what ${esc(therapistName)} sees. Nothing leaves this chat unless you send it.</p>
        
        <div class="privacy-note">
          <strong>Connected to:</strong> ${esc(therapistName)}<br>
          <button class="btn-link" style="margin-top: 8px;" onclick="handleUnlink()">Unlink from therapist</button>
        </div>
        
        <h4 style="margin-top: 20px; margin-bottom: 12px;">What I've shared</h4>
        <div id="sharedMessagesList">
          <p style="color: var(--text-secondary); font-size: 14px;">Loading...</p>
        </div>
        
        <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle);">
          <button class="btn-link" style="color: var(--danger);" onclick="handleLogout()">Log out of Alo</button>
        </div>
        
        <div class="button-group">
          <button onclick="closeModal(this.closest('.modal-overlay'))">Close</button>
        </div>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      loadSharedMessages();
    }

    async function loadSharedMessages() {
      try {
        const messages = await api(`/rest/v1/client_messages?client_id=eq.${clientId}&revoked_at=is.null&order=created_at.desc`);
        
        const container = document.getElementById('sharedMessagesList');
        
        if (!messages?.length) {
          container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px;">No messages sent yet</p>';
          return;
        }
        
        container.innerHTML = messages.map(m => `
          <div class="message-item">
            <div class="message-content">
              <div class="message-date">${new Date(m.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>
              <div class="message-text">${esc(m.message)}</div>
            </div>
            ${!m.read ? `<button class="message-delete" onclick="handleDeleteMessage('${m.id}')">Delete</button>` : ''}
          </div>
        `).join('');
        
      } catch (err) {
        console.error('Error loading messages:', err);
      }
    }

    async function handleDeleteMessage(id) {
      showConfirm(
        'Delete this message?',
        'If your therapist already opened it, deleting won\'t undo what they saw.',
        'Delete',
        async function() {
          try {
            await api(`/rest/v1/client_messages?id=eq.${id}`, {
              method: 'PATCH',
              body: JSON.stringify({
                revoked_at: new Date().toISOString()
              })
            });
            loadSharedMessages();
            showToast('Message deleted', 'default');
          } catch (err) {
            showToast('Failed to delete message');
          }
        },
        { danger: true }
      );
    }

    async function handleUnlink() {
      const therapistName = document.getElementById('trustBadgeText').textContent.split('with ')[1] || 'your therapist';
      
      showConfirm(
        'Unlink from ' + therapistName + '?',
        'You can reconnect later with a new invite code. This won\'t delete your account.',
        'Unlink',
        async function() {
          try {
            await api(`/rest/v1/therapist_clients?id=eq.${therapistLink.id}`, {
              method: 'PATCH',
              body: JSON.stringify({ status: 'inactive' })
            });
            
            therapistLink = null;
            chatSettings = null;
            activeHomework = null;
            
            resetToGuestUI();
            closeModal(document.querySelector('.modal-overlay'));
            showToast('Unlinked from therapist', 'default');
            
          } catch (err) {
            showToast('Failed to unlink. Please try again.');
          }
        },
        { danger: true }
      );
    }

    // =====================================================
    // SHARE MODAL
    // =====================================================
    function showShareModal() {
      const summaryPrompt = `Alo, please create a 5-bullet summary of our conversation for me to share with my therapist or someone I trust. Include key insights and one suggested next step.`;
      const fullPrompt = `Alo, please provide a complete transcript of our entire conversation in a clean, readable format that I can share.`;
      
      const modal = createModal('Share Your Conversation', `
        <div class="share-options">
          <button id="optionSummary" class="share-option active">
            <span class="share-option-icon">üìù</span>
            <span class="share-option-label">Summary</span>
          </button>
          <button id="optionFull" class="share-option">
            <span class="share-option-icon">üìÑ</span>
            <span class="share-option-label">Full</span>
          </button>
          <button id="optionRange" class="share-option">
            <span class="share-option-icon">üéØ</span>
            <span class="share-option-label">Range</span>
          </button>
        </div>
        
        <div id="instructionsArea">
          <div id="summaryInstructions">
            <p style="font-size: 14px; margin: 12px 0 8px 0; color: var(--text-secondary);">
              Get a 5-bullet summary perfect for sharing with your therapist
            </p>
            <ol style="font-size: 14px; line-height: 1.5; margin: 12px 0;">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates a summary</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="copy-box">
              <textarea readonly id="summaryPromptText">${summaryPrompt}</textarea>
              <button id="copySummaryBtn" class="btn-primary">üìã Copy Message</button>
            </div>
          </div>
          
          <div id="fullInstructions" style="display: none;">
            <p style="font-size: 14px; margin: 12px 0 8px 0; color: var(--text-secondary);">
              Get a complete transcript of everything discussed
            </p>
            <ol style="font-size: 14px; line-height: 1.5; margin: 12px 0;">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates full transcript</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="copy-box">
              <textarea readonly id="fullPromptText">${fullPrompt}</textarea>
              <button id="copyFullBtn" class="btn-primary">üìã Copy Message</button>
            </div>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
              üí° Full transcripts are long ‚Äî summary is usually better for sharing
            </p>
          </div>
          
          <div id="rangeInstructions" style="display: none;">
            <p style="font-size: 14px; margin: 12px 0 8px 0; color: var(--text-secondary);">
              Share specific parts (example: turns 3-8)
            </p>
            <div style="display: flex; gap: 12px; margin: 16px 0;">
              <div style="flex: 1;">
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">Start:</label>
                <input type="number" id="rangeStart" min="1" value="1" 
                  style="width: 100%; padding: 10px; border: 1px solid var(--border-visible); border-radius: 6px; font-size: 16px;">
              </div>
              <div style="flex: 1;">
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 4px;">End:</label>
                <input type="number" id="rangeEnd" min="1" value="10" 
                  style="width: 100%; padding: 10px; border: 1px solid var(--border-visible); border-radius: 6px; font-size: 16px;">
              </div>
            </div>
            <button id="copyRangeBtn" class="btn-primary" style="width: 100%;">
              üìã Copy Range Message
            </button>
            <p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
              üí° Count message bubbles to find turn numbers
            </p>
          </div>
        </div>
        
        <div class="privacy-note" style="font-size: 12px; margin-top: 16px;">
          <strong>How to share:</strong> After Alo creates your summary/transcript, long-press on it and select "Copy". Then paste into Messages, Email, or Notes.
        </div>
        
        <div class="button-group" style="margin-top: 20px;">
          <button onclick="closeModal(this.closest('.modal-overlay'))">Close</button>
        </div>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
      
      setupShareTabs(modal, summaryPrompt, fullPrompt);
    }

    function setupShareTabs(modal, summaryPrompt, fullPrompt) {
      const optionSummary = modal.querySelector('#optionSummary');
      const optionFull = modal.querySelector('#optionFull');
      const optionRange = modal.querySelector('#optionRange');
      
      const summaryInstructions = modal.querySelector('#summaryInstructions');
      const fullInstructions = modal.querySelector('#fullInstructions');
      const rangeInstructions = modal.querySelector('#rangeInstructions');
      
      function switchTab(tab) {
        [optionSummary, optionFull, optionRange].forEach(btn => btn.classList.remove('active'));
        summaryInstructions.style.display = 'none';
        fullInstructions.style.display = 'none';
        rangeInstructions.style.display = 'none';
        
        if (tab === 'summary') { optionSummary.classList.add('active'); summaryInstructions.style.display = 'block'; }
        else if (tab === 'full') { optionFull.classList.add('active'); fullInstructions.style.display = 'block'; }
        else if (tab === 'range') { optionRange.classList.add('active'); rangeInstructions.style.display = 'block'; }
      }
      
      optionSummary.addEventListener('click', () => switchTab('summary'));
      optionFull.addEventListener('click', () => switchTab('full'));
      optionRange.addEventListener('click', () => switchTab('range'));
      
      function setupCopyBtn(btn, getText) {
        btn.addEventListener('click', async function() {
          const original = btn.textContent;
          const success = await copyToClipboard(getText());
          if (success) {
            btn.textContent = '‚úì Copied!';
            btn.style.background = 'var(--success)';
            setTimeout(function() { btn.textContent = original; btn.style.background = ''; }, 2000);
          }
        });
      }
      
      setupCopyBtn(modal.querySelector('#copySummaryBtn'), () => summaryPrompt);
      setupCopyBtn(modal.querySelector('#copyFullBtn'), () => fullPrompt);
      setupCopyBtn(modal.querySelector('#copyRangeBtn'), () => {
        const s = modal.querySelector('#rangeStart').value;
        const e = modal.querySelector('#rangeEnd').value;
        return `Alo, please provide turns ${s} through ${e} of our conversation in a clean, readable format that I can share.`;
      });
    }

    // =====================================================
    // SAFETY RESOURCES MODAL
    // =====================================================
    function showSafetyResources(event) {
      if (event) event.preventDefault();
      
      const modal = createModal('Safety Resources', `
        <p><strong>Need to talk to someone right now?</strong></p>
        <ul>
          <li><strong>United States:</strong> Call or text <a href="tel:988">988</a> (Suicide &amp; Crisis Lifeline)</li>
          <li><strong>United Kingdom:</strong> Call 116 123 (Samaritans)</li>
          <li><strong>Canada:</strong> Call 1-833-456-4566 (Talk Suicide Canada)</li>
          <li><strong>Australia:</strong> Call 13 11 14 (Lifeline)</li>
          <li><strong>International:</strong> Visit <a href="https://findahelpline.com" target="_blank" rel="noopener">findahelpline.com</a></li>
        </ul>
        
        <div class="privacy-note">
          <strong>About Alo:</strong> Alo helps you process emotions between therapy sessions. 
          It is not a therapist, crisis service, or medical provider. If you're experiencing a mental health 
          emergency, please use the resources above.
        </div>
        
        <button onclick="closeModal(this.closest('.modal-overlay'))">Close</button>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
    }

    // =====================================================
    // LOGOUT
    // =====================================================
    function handleLogout() {
      showConfirm(
        'Log out of Alo?',
        'You can sign back in anytime with your email and password.',
        'Log Out',
        function() {
          clientSession = null;
          clientId = null;
          therapistLink = null;
          chatSettings = null;
          activeHomework = null;
          localStorage.removeItem('alo_client_session');
          
          resetToGuestUI();
          closeModal(document.querySelector('.modal-overlay'));
          showToast('Logged out', 'default');
        }
      );
    }

    function resetToGuestUI() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge guest';
      badgeText.textContent = '';
      
      const svg = badge.querySelector('svg');
      if (svg) svg.remove();
      
      document.getElementById('connectBtn').classList.remove('hidden');
      document.getElementById('messageBtn').classList.add('hidden');
      document.getElementById('privacyBtn').classList.add('hidden');
      document.getElementById('homeworkContainer').classList.remove('show');
    }

    // =====================================================
    // HOMEWORK COMPLETION
    // =====================================================
    async function handleHomeworkDone() {
      if (!activeHomework || !clientSession) return;
      
      showConfirm(
        'Mark as complete?',
        'Your therapist will see that you completed this. Nice work!',
        '‚úì Complete',
        async function() {
          try {
            await api(`/rest/v1/homework_cards?id=eq.${activeHomework.id}`, {
              method: 'PATCH',
              body: JSON.stringify({
                completed_at: new Date().toISOString(),
                is_active: false
              })
            });
            
            const card = document.querySelector('.homework-card');
            card.classList.add('completed');
            document.getElementById('homeworkTitle').textContent = 'COMPLETED ‚úì';
            document.getElementById('homeworkBody').innerHTML = `
              <p>${esc(activeHomework.title || activeHomework.goal)}</p>
              <p class="homework-complete-note">Marked complete ¬∑ ${new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
              <p class="homework-complete-note">Your therapist can see this.</p>
            `;
            activeHomework = null;
            showToast('Homework completed ‚úì', 'success');
            
          } catch (err) {
            console.error('Error completing homework:', err);
            showToast('Could not mark homework as complete. Please try again.');
          }
        }
      );
    }

    // =====================================================
    // TERMS OF USE MODAL
    // =====================================================
    function showTermsModal(event) {
      if (event) event.preventDefault();
      
      const modal = createModal('Terms of Use', `
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Last updated: February 2026</p>
        
        <p><strong>What Alo Is</strong></p>
        <p>Alo is a self-help emotional support tool that uses AI to help you think through decisions and process emotions. Alo is not a therapist, counselor, medical provider, or crisis service.</p>
        
        <p><strong>What Alo Is Not</strong></p>
        <p>Alo does not provide diagnoses, treatment plans, prescriptions, or clinical recommendations. If you need mental health treatment, please work with a licensed professional. If you are in crisis, call 988 (US) or your local emergency number.</p>
        
        <p><strong>Your Privacy</strong></p>
        <p>Your conversations with Alo are processed by AI but are not stored or accessible to anyone ‚Äî including your therapist, Alo staff, or any third party. If you choose to connect with a therapist, only messages you explicitly send and homework completion status are visible to them. See our Privacy Policy for details.</p>
        
        <p><strong>Your Responsibility</strong></p>
        <p>You use Alo voluntarily and at your own discretion. Alo is a supplement to ‚Äî not a replacement for ‚Äî professional care. You are responsible for decisions you make based on conversations with Alo.</p>
        
        <p><strong>Account &amp; Data</strong></p>
        <p>You may create an account to connect with your therapist. You may delete your account and data at any time by contacting support. Disconnecting from a therapist does not delete your account.</p>
        
        <p><strong>Limitations</strong></p>
        <p>Alo is provided "as is." We make no guarantees about availability, accuracy of AI responses, or fitness for any particular purpose. Alo has crisis detection features, but these are not infallible. Always seek professional help in emergencies.</p>
        
        <button onclick="closeModal(this.closest('.modal-overlay'))">Close</button>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
    }

    // =====================================================
    // PRIVACY POLICY MODAL
    // =====================================================
    function showPrivacyModal2(event) {
      if (event) event.preventDefault();
      
      const modal = createModal('Privacy Policy', `
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">Last updated: February 2026</p>
        
        <p><strong>What We Collect</strong></p>
        <p>If you create an account: your email address and an encrypted password. If you connect to a therapist: the connection status and any messages you choose to send them. If your therapist assigns homework: completion status when you mark it done.</p>
        
        <p><strong>What We Do NOT Collect</strong></p>
        <p>We do not store, read, or have access to your conversations with Alo. Chat transcripts are processed in real-time by AI and are not retained on any server. Your therapist cannot see your conversations.</p>
        
        <p><strong>How Data Is Used</strong></p>
        <p>Account data is used only to authenticate you and maintain your therapist connection. Messages you send to your therapist are stored until you delete them. Homework completion status is shared with your connected therapist.</p>
        
        <p><strong>Data Storage</strong></p>
        <p>Data is stored on Supabase (US-hosted, SOC 2 compliant infrastructure). Connections are encrypted in transit (HTTPS/TLS).</p>
        
        <p><strong>Your Rights</strong></p>
        <p>You can: view what you've shared (My Privacy), delete sent messages (if unread), disconnect from your therapist, log out and clear your session, request full account deletion by contacting support.</p>
        
        <p><strong>Third Parties</strong></p>
        <p>We do not sell, rent, or share your personal data with advertisers or data brokers. AI conversation processing is handled by Anthropic (Claude) via Botpress. No conversation content is stored by these providers beyond real-time processing.</p>
        
        <p><strong>Contact</strong></p>
        <p>Questions about your data? Contact us at privacy@along.inc</p>
        
        <button onclick="closeModal(this.closest('.modal-overlay'))">Close</button>
      `);
      
      document.body.appendChild(modal);
      modal.classList.add('show');
    }

    // =====================================================
    // MODAL SYSTEM (with focus trap + return focus)
    // =====================================================
    let _modalOpener = null;

    function createModal(title, content) {
      _modalOpener = document.activeElement;
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.setAttribute('role', 'dialog');
      overlay.setAttribute('aria-modal', 'true');
      
      const titleId = 'modalTitle_' + Date.now();
      overlay.setAttribute('aria-labelledby', titleId);
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.setAttribute('tabindex', '-1');
      modalContent.innerHTML = `
        <button class="modal-close" aria-label="Close">&times;</button>
        <h2 id="${titleId}">${title}</h2>
        ${content}
      `;
      
      overlay.appendChild(modalContent);
      
      // Close on backdrop click
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) closeModal(overlay);
      });
      
      // Close button
      modalContent.querySelector('.modal-close').addEventListener('click', function() {
        closeModal(overlay);
      });
      
      // Focus trap + Escape
      function getFocusables() {
        return [...modalContent.querySelectorAll(
          'a[href], button:not([disabled]), textarea, input:not([disabled]), select, [tabindex]:not([tabindex="-1"])'
        )];
      }
      
      function onKeydown(e) {
        if (e.key === 'Escape') {
          closeModal(overlay);
          return;
        }
        if (e.key === 'Tab') {
          const focusables = getFocusables();
          if (!focusables.length) return;
          const first = focusables[0];
          const last = focusables[focusables.length - 1];
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã
          else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
      
      document.addEventListener('keydown', onKeydown);
      overlay._cleanup = function() {
        document.removeEventListener('keydown', onKeydown);
      };
      
      // Auto-focus first input or the close button
      setTimeout(function() {
        const firstInput = modalContent.querySelector('input, textarea');
        if (firstInput) {
          firstInput.focus();
        } else {
          const firstBtn = modalContent.querySelector('button:not(.modal-close)');
          if (firstBtn) firstBtn.focus();
          else modalContent.focus();
        }
      }, 50);
      
      return overlay;
    }

    function closeModal(modal) {
      if (!modal || !modal.parentNode) return;
      if (modal._cleanup) modal._cleanup();
      modal.classList.remove('show');
      setTimeout(function() {
        modal.remove();
        // Return focus to opener
        if (_modalOpener && _modalOpener.focus) {
          _modalOpener.focus();
          _modalOpener = null;
        }
      }, 200);
    }

    // =====================================================
    // UTILITIES
    // =====================================================
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textArea);
        return success;
      }
    }

    function esc(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
  </script>
</body>
</html>
