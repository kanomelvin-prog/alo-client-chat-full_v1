<!DOCTYPE html>
<!-- ALO CLIENT CHAT v2.4 — Feb 20, 2026 — 16-persona review P0+P1 fixes -->
<!-- Changes: border-color fix, profiles on signup, homework writes to DB,
     chat settings enforcement, privacy bar, header warmth, microcopy improvements,
     homework viewed tracking, inline styles moved to CSS classes -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Alo">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#FDFBF7">
  
  <!-- Preconnect hints for faster iframe load -->
  <link rel="preconnect" href="https://cdn.botpress.cloud">
  <link rel="preconnect" href="https://files.bpcontent.cloud">
  
  <!-- Open Graph — link preview when therapist texts URL to client -->
  <meta property="og:title" content="Alo — Someone to think out loud with">
  <meta property="og:description" content="A private space to process your thoughts and emotions. Your therapist recommended Alo as a companion between sessions.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://kanomelvin-prog.github.io/alo-client-chat-full_v1/">
  <meta property="og:image" content="https://kanomelvin-prog.github.io/alo-client-chat-full_v1/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta name="description" content="Alo is a private emotional support companion. Process thoughts between therapy sessions with Socratic questioning.">
  
  <title>Alo — Someone to think out loud with</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <header>
    <div class="brand">
      <div class="brand-icon">A</div>
      <div class="brand-text">
        <h1 class="brand-name">Alo</h1>
        <span>Someone to think out loud with</span>
        <div id="trustBadge" class="trust-badge guest">
          <span id="trustBadgeText"></span>
        </div>
      </div>
    </div>
    <div class="header-actions">
      <button id="connectBtn" class="btn-primary">Link to Therapist</button>
      <button id="logoutBtn" class="btn-link hidden">Log Out</button>
      <button id="privacyBtn" class="hidden">My Privacy</button>
      <button id="messageBtn" class="hidden">Message</button>
      <button id="shareChat">Share</button>
    </div>
  </header>

  <!-- Privacy assurance bar — shown on first visit, dismissible -->
  <div id="privacyBar" class="privacy-bar">
    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
    </svg>
    <span class="privacy-bar-text">Your conversations with Alo are private. No one else can see what you discuss here.</span>
    <button class="privacy-bar-dismiss" id="privacyBarDismiss" aria-label="Dismiss">&times;</button>
  </div>

  <main id="chatMain">
    <!-- Homework card (hidden unless client has active homework) -->
    <div id="homeworkContainer" class="homework-container">
      <div class="homework-card" id="homeworkCard">
        <div class="homework-header">
          <div class="homework-title" id="homeworkTitle">From your therapist</div>
          <button class="homework-collapse" id="homeworkCollapseBtn" 
            aria-label="Toggle homework" 
            aria-controls="homeworkBody" 
            aria-expanded="true">−</button>
        </div>
        <div class="homework-body" id="homeworkBody">
          <p id="homeworkGoal"></p>
          <div class="homework-actions">
            <button class="btn-primary" id="homeworkDoneBtn">✓ I did this</button>
            <button class="btn-link" id="homeworkHideBtn">Hide for now</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat iframe -->
    <div class="chat-container">
      <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-message">
          <div class="spinner"></div>
          <p>Loading Alo...</p>
        </div>
      </div>
      
      <iframe
        id="aloFrame"
        src="https://cdn.botpress.cloud/webchat/v3.6/shareable.html?configUrl=https://files.bpcontent.cloud/2026/02/20/16/20260220161212-N5ZPU2UY.json"
        allow="clipboard-read; clipboard-write"
        title="Alo Chat Interface"
        aria-label="Chatbot Conversation Window"
      ></iframe>
    </div>
  </main>

  <footer>
    <div class="crisis-notice">
      Alo helps you think — not a therapist or doctor. <span class="crisis-link">Need help now?</span> <a href="tel:988">988 US</a>.
    </div>
    <div class="footer-links">
      <a href="#" id="termsLink">Terms</a>
      <a href="#" id="privacyLink">Privacy Policy</a>
    </div>
  </footer>

  <!-- Modals container -->
  <div id="modalsContainer"></div>

  <!-- Toast container -->
  <div id="toastContainer" class="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
  <script>
    // =====================================================
    // CONFIG
    // =====================================================
    const SUPABASE_URL = 'https://lelsdezstbnzyxvsvbyx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlbHNkZXpzdGJuenl4dnN2Ynl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDk1NDUsImV4cCI6MjA3OTE4NTU0NX0.mm1POxfEEoRXyTF08NsUZOau6qA_UdZJnoUH_5bkQas';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        storage: window.localStorage,
        storageKey: 'alo_client_session',
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    let clientId = null;
    let therapistLink = null;
    let chatSettings = {};
    let currentHomeworkId = null;

    // =====================================================
    // TOAST NOTIFICATIONS
    // =====================================================
    function showToast(message, duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // =====================================================
    // MODAL SYSTEM
    // =====================================================
    function createModal(title, bodyHTML, options = {}) {
      const {
        confirmLabel = 'Confirm',
        cancelLabel = 'Cancel',
        onConfirm = null,
        onCancel = null,
        showCancel = true,
        dangerous = false
      } = options;

      const modalId = 'modal-' + Date.now();
      const modalHTML = `
        <div class="modal-overlay" id="${modalId}" role="dialog" aria-modal="true" aria-labelledby="${modalId}-title">
          <div class="modal-content">
            <div class="modal-header">
              <h2 id="${modalId}-title">${title}</h2>
              <button class="modal-close" aria-label="Close dialog">&times;</button>
            </div>
            <div class="modal-body">
              ${bodyHTML}
            </div>
            <div class="modal-footer">
              ${showCancel ? `<button class="btn-secondary modal-cancel">${cancelLabel}</button>` : ''}
              <button class="btn-primary modal-confirm ${dangerous ? 'btn-danger' : ''}">${confirmLabel}</button>
            </div>
          </div>
        </div>
      `;

      const container = document.getElementById('modalsContainer');
      container.insertAdjacentHTML('beforeend', modalHTML);

      const modal = document.getElementById(modalId);
      const closeBtn = modal.querySelector('.modal-close');
      const cancelBtn = modal.querySelector('.modal-cancel');
      const confirmBtn = modal.querySelector('.modal-confirm');

      const firstInput = modal.querySelector('input, textarea, select');
      if (firstInput) {
        setTimeout(() => firstInput.focus(), 100);
      } else {
        setTimeout(() => confirmBtn.focus(), 100);
      }

      function closeModal() {
        modal.classList.add('closing');
        setTimeout(() => modal.remove(), 300);
      }

      closeBtn.addEventListener('click', () => {
        if (onCancel) onCancel();
        closeModal();
      });

      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => {
          if (onCancel) onCancel();
          closeModal();
        });
      }

      confirmBtn.addEventListener('click', async () => {
        if (onConfirm) {
          const result = await onConfirm();
          if (result !== false) closeModal();
        } else {
          closeModal();
        }
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          if (onCancel) onCancel();
          closeModal();
        }
      });

      document.addEventListener('keydown', function escHandler(e) {
        if (e.key === 'Escape' && document.getElementById(modalId)) {
          if (onCancel) onCancel();
          closeModal();
          document.removeEventListener('keydown', escHandler);
        }
      });

      setTimeout(() => modal.classList.add('show'), 10);

      return modal;
    }

    // =====================================================
    // CONFIRM DIALOG
    // =====================================================
    function showConfirm(title, message, options = {}) {
      return new Promise((resolve) => {
        createModal(
          title,
          `<p>${message}</p>`,
          {
            ...options,
            onConfirm: () => {
              resolve(true);
            },
            onCancel: () => {
              resolve(false);
            }
          }
        );
      });
    }

    // =====================================================
    // UI STATE MANAGEMENT
    // =====================================================
    function showLoggedInNoConnection() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge';
      badgeText.textContent = 'Logged in';
      badge.style.display = 'flex';
      
      const svg = badge.querySelector('svg');
      if (svg) svg.remove();
      
      document.getElementById('connectBtn').classList.remove('hidden');
      document.getElementById('connectBtn').textContent = 'Link to Therapist';
      document.getElementById('logoutBtn').classList.remove('hidden');
      document.getElementById('privacyBtn').classList.add('hidden');
      document.getElementById('messageBtn').classList.add('hidden');
    }

    function showConnectedUI(therapistName, clientName) {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      
      badge.className = 'trust-badge connected';
      
      if (!badge.querySelector('svg')) {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('fill', 'none');
        svg.setAttribute('viewBox', '0 0 24 24');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('stroke-width', '2');
        svg.style.width = '12px';
        svg.style.height = '12px';
        
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('d', 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z');
        
        svg.appendChild(path);
        badge.insertBefore(svg, badgeText);
      }
      
      badgeText.textContent = `Hi ${clientName} \u00B7 with ${therapistName}`;
      
      document.getElementById('connectBtn').classList.add('hidden');
      document.getElementById('logoutBtn').classList.remove('hidden');
      document.getElementById('privacyBtn').classList.remove('hidden');
      
      // Enforce chat settings from dashboard
      if (chatSettings.allow_messages !== false) {
        document.getElementById('messageBtn').classList.remove('hidden');
      } else {
        document.getElementById('messageBtn').classList.add('hidden');
      }
    }

    function resetToGuestUI() {
      const badge = document.getElementById('trustBadge');
      const badgeText = document.getElementById('trustBadgeText');
      badge.className = 'trust-badge guest';
      badgeText.textContent = '';
      
      const svg = badge.querySelector('svg');
      if (svg) svg.remove();
      
      document.getElementById('connectBtn').classList.remove('hidden');
      document.getElementById('connectBtn').textContent = 'Link to Therapist';
      document.getElementById('logoutBtn').classList.add('hidden');
      document.getElementById('messageBtn').classList.add('hidden');
      document.getElementById('privacyBtn').classList.add('hidden');
      document.getElementById('homeworkContainer').classList.remove('show');
    }

    // =====================================================
    // HOMEWORK
    // =====================================================
    async function loadHomework() {
      // P1: Enforce chat settings — if therapist disabled homework visibility, skip
      if (chatSettings.allow_homework === false) {
        return;
      }

      try {
        const homework = await api(`/rest/v1/homework_cards?client_id=eq.${clientId}&is_active=eq.true&order=created_at.desc&limit=1`);
        
        if (homework && homework.length > 0) {
          const hw = homework[0];
          currentHomeworkId = hw.id;
          document.getElementById('homeworkTitle').textContent = hw.title || 'From your therapist';
          document.getElementById('homeworkGoal').textContent = hw.goal || '';
          document.getElementById('homeworkContainer').classList.add('show');

          // P1: Track that client viewed this homework
          if (!hw.viewed_at) {
            try {
              await api(`/rest/v1/homework_cards?id=eq.${hw.id}`, 'PATCH', {
                viewed_at: new Date().toISOString()
              });
            } catch (viewErr) {
              console.error('Error tracking homework view:', viewErr);
            }
          }
        }
      } catch (err) {
        console.error('Error loading homework:', err);
      }
    }

    async function handleHomeworkDone() {
      showConfirm(
        'Mark as complete?',
        'Nice work. This lets your therapist know you engaged with this exercise.',
        {
          confirmLabel: 'Yes, I did this',
          cancelLabel: 'Not yet'
        }
      ).then(async (confirmed) => {
        if (confirmed && currentHomeworkId) {
          try {
            // P0: Actually write completion to Supabase
            await api(`/rest/v1/homework_cards?id=eq.${currentHomeworkId}`, 'PATCH', {
              is_active: false,
              completed_at: new Date().toISOString()
            });
            showToast('Marked complete');
            document.getElementById('homeworkContainer').classList.remove('show');
          } catch (err) {
            console.error('Error completing homework:', err);
            showToast('Could not save. Please try again.');
          }
        } else if (confirmed && !currentHomeworkId) {
          showToast('Marked complete');
          document.getElementById('homeworkContainer').classList.remove('show');
        }
      });
    }

    // =====================================================
    // LOGOUT HANDLER
    // =====================================================
    async function handleLogout() {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Error signing out:', error);
        showToast('Error signing out. Please try again.');
        return;
      }
      
      clientId = null;
      therapistLink = null;
      chatSettings = {};
      currentHomeworkId = null;
      
      location.reload();
    }

    // =====================================================
    // CONNECT MODAL
    // =====================================================
    function showConnectModal() {
      createModal('Link to Your Therapist', `
        <p>Stay connected with your therapist between sessions. They can send you exercises, and you can message them anytime.</p>
        <p class="modal-hint">Your conversations with Alo stay completely private — your therapist never sees them.</p>
        <div style="margin-top: 16px;">
          <label for="inviteCodeInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Invite code</label>
          <input type="text" id="inviteCodeInput" class="modal-input" placeholder="Enter the code your therapist gave you" autocomplete="off" />
        </div>
        <p class="modal-sign-in-link">
          Already have an account? <button onclick="document.querySelector('.modal-overlay').remove(); showLoginModal();">Sign in</button>
        </p>
      `, {
        confirmLabel: 'Link',
        cancelLabel: 'Maybe later',
        onConfirm: async () => {
          const code = document.getElementById('inviteCodeInput').value.trim();
          if (!code) {
            showToast('Please enter an invite code');
            return false;
          }
          await handleConnectSubmit(code);
        }
      });
    }

    async function handleConnectSubmit(inviteCode) {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (!user) {
        showLoginModal(inviteCode);
        return;
      }

      try {
        const link = await api(`/rest/v1/therapist_clients?invite_code=eq.${inviteCode}&status=eq.pending`);
        
        if (!link || link.length === 0) {
          showToast('Invalid invite code. Check the code your therapist sent you.');
          return;
        }

        const linkId = link[0].id;
        await api(`/rest/v1/therapist_clients?id=eq.${linkId}`, 'PATCH', {
          client_id: user.id,
          status: 'active'
        });

        showToast('Connected successfully!');
        await loadConnectedState();
      } catch (err) {
        console.error('Connection error:', err);
        showToast('Connection failed. Please try again.');
      }
    }

    // =====================================================
    // LOGIN MODAL
    // =====================================================
    function showLoginModal(inviteCode = null) {
      createModal('Sign In or Create Account', `
        <p>Create an account or sign in to connect with your therapist.</p>
        <div style="margin-top: 16px;">
          <label for="emailInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Email</label>
          <input type="email" id="emailInput" class="modal-input" placeholder="Email" autocomplete="email" style="margin-bottom: 12px;" />
          <label for="passwordInput" style="font-size: 13px; font-weight: 500; display: block; margin-bottom: 6px;">Password</label>
          <input type="password" id="passwordInput" class="modal-input" placeholder="Password" autocomplete="current-password" />
        </div>
      `, {
        confirmLabel: 'Continue',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const email = document.getElementById('emailInput').value.trim();
          const password = document.getElementById('passwordInput').value;
          
          if (!email || !password) {
            showToast('Please enter email and password');
            return false;
          }

          // Try sign in first
          let { data, error } = await supabase.auth.signInWithPassword({ email, password });
          
          // If sign in fails, try sign up
          if (error && error.message.includes('Invalid login credentials')) {
            const signUpResult = await supabase.auth.signUp({ email, password });
            
            if (signUpResult.error) {
              showToast('Authentication failed. Please try again.');
              return false;
            }
            
            if (!signUpResult.data.session) {
              showToast('Account created! Check your email to confirm.');
              return;
            }
            
            data = signUpResult.data;
            error = null;

            // P0: Create profiles row on sign-up
            try {
              const displayName = email.split('@')[0];
              await api('/rest/v1/profiles', 'POST', {
                id: data.user.id,
                role: 'client',
                display_name: displayName,
                email: email
              });
            } catch (profileErr) {
              // Non-blocking — profile creation failure shouldn't break signup
              console.error('Error creating profile:', profileErr);
            }
          }

          if (error) {
            showToast('Authentication failed. Please try again.');
            return false;
          }

          showToast('Signed in successfully');

          if (inviteCode) {
            await handleConnectSubmit(inviteCode);
          } else {
            await loadConnectedState();
          }
        }
      });
    }

    // =====================================================
    // MESSAGE MODAL
    // =====================================================
    function showMessageModal() {
      const therapistName = therapistLink ? document.getElementById('trustBadgeText').textContent.split('with ')[1] : 'your therapist';
      
      createModal(`Message ${therapistName}`, `
        <p class="modal-subtext">
          ${therapistName} will see this message in their dashboard. They'll respond when they can.
        </p>
        <textarea id="messageTextarea" class="modal-textarea" placeholder="Type your message..."></textarea>
      `, {
        confirmLabel: 'Send',
        cancelLabel: 'Cancel',
        onConfirm: async () => {
          const messageText = document.getElementById('messageTextarea').value.trim();
          if (!messageText) {
            showToast('Please enter a message');
            return false;
          }

          try {
            await api('/rest/v1/client_messages', 'POST', {
              client_id: clientId,
              therapist_id: therapistLink.therapist_id,
              message: messageText,
              read: false
            });

            showToast('Message sent');
          } catch (err) {
            console.error('Error sending message:', err);
            showToast('Failed to send message. Please try again.');
            return false;
          }
        }
      });
    }

    // =====================================================
    // PRIVACY MODAL
    // =====================================================
    function showPrivacyModal() {
      const therapistName = document.getElementById('trustBadgeText').textContent.split('with ')[1] || 'your therapist';
      
      createModal('Your Privacy', `
        <h3 class="modal-section-title">What ${therapistName} sees</h3>
        <ul class="modal-list">
          <li>Whether you're connected to Alo</li>
          <li>If you completed homework exercises</li>
          <li>Messages you send them directly</li>
        </ul>
        
        <h3 class="modal-section-title">What they never see</h3>
        <ul class="modal-list">
          <li><strong>Your conversations with Alo</strong></li>
          <li>What you talked about</li>
          <li>How you're feeling</li>
        </ul>
        
        <p class="modal-divider">
          Alo is a private space. Your therapist trusts you to share what matters when you're ready.
        </p>
      `, {
        confirmLabel: 'Got it',
        showCancel: false
      });
    }

    // =====================================================
    // SHARE MODAL (3-option: Summary/Full/Range)
    // =====================================================
    function showShareModal() {
      const summaryPrompt = `Alo, please create a 5-bullet summary of our conversation for me to share with my therapist or someone I trust. Include key insights and one suggested next step.`;
      const fullPrompt = `Alo, please provide a complete transcript of our entire conversation in a clean, readable format that I can share.`;
      
      const modal = createModal('Share Your Conversation', `
        <div class="share-options">
          <button class="share-option active" id="optionSummary">
            <span class="share-option-icon">\u{1F4DD}</span>
            <span class="share-option-label">Summary</span>
          </button>
          <button class="share-option" id="optionFull">
            <span class="share-option-icon">\u{1F4C4}</span>
            <span class="share-option-label">Full</span>
          </button>
          <button class="share-option" id="optionRange">
            <span class="share-option-icon">\u{1F3AF}</span>
            <span class="share-option-label">Range</span>
          </button>
        </div>
        
        <div id="instructionsArea">
          <div id="summaryInstructions">
            <p class="share-instructions">
              Get a 5-bullet summary perfect for sharing with your therapist
            </p>
            <ol class="share-steps">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates a summary</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="share-prompt-box">
              <textarea readonly id="summaryPromptText" class="share-prompt-textarea">${summaryPrompt}</textarea>
              <button id="copySummaryBtn" class="btn-primary" style="width: 100%; margin-top: 8px;">\u{1F4CB} Copy Message</button>
            </div>
          </div>
          
          <div id="fullInstructions" style="display: none;">
            <p class="share-instructions">
              Get a complete transcript of everything discussed
            </p>
            <ol class="share-steps">
              <li>Copy the message below</li>
              <li>Paste it into chat</li>
              <li>Alo creates full transcript</li>
              <li>Long-press to copy &amp; share</li>
            </ol>
            <div class="share-prompt-box">
              <textarea readonly id="fullPromptText" class="share-prompt-textarea">${fullPrompt}</textarea>
              <button id="copyFullBtn" class="btn-primary" style="width: 100%; margin-top: 8px;">\u{1F4CB} Copy Message</button>
            </div>
            <p class="share-hint">
              \u{1F4A1} Full transcripts are long — summary is usually better for sharing
            </p>
          </div>
          
          <div id="rangeInstructions" style="display: none;">
            <p class="share-instructions">
              Share specific parts (example: turns 3-8)
            </p>
            <div class="range-inputs">
              <div class="range-field">
                <label for="rangeStart">Start:</label>
                <input type="number" id="rangeStart" min="1" value="1">
              </div>
              <div class="range-field">
                <label for="rangeEnd">End:</label>
                <input type="number" id="rangeEnd" min="1" value="10">
              </div>
            </div>
            <button id="copyRangeBtn" class="btn-primary" style="width: 100%;">
              \u{1F4CB} Copy Range Message
            </button>
            <p class="share-hint">
              \u{1F4A1} Count message bubbles to find turn numbers
            </p>
          </div>
        </div>
        
        <p class="share-footer-note">
          <strong>How to share:</strong> After Alo creates your summary/transcript, long-press on it and select "Copy". Then paste into Messages, Email, or Notes.
        </p>
      `, {
        confirmLabel: 'Close',
        showCancel: false
      });
      
      setupShareTabs(modal, summaryPrompt, fullPrompt);
    }

    function setupShareTabs(modal, summaryPrompt, fullPrompt) {
      const optionSummary = modal.querySelector('#optionSummary');
      const optionFull = modal.querySelector('#optionFull');
      const optionRange = modal.querySelector('#optionRange');
      
      const summaryInstructions = modal.querySelector('#summaryInstructions');
      const fullInstructions = modal.querySelector('#fullInstructions');
      const rangeInstructions = modal.querySelector('#rangeInstructions');
      
      function switchTab(tab) {
        [optionSummary, optionFull, optionRange].forEach(btn => {
          btn.classList.remove('active');
        });
        
        summaryInstructions.style.display = 'none';
        fullInstructions.style.display = 'none';
        rangeInstructions.style.display = 'none';
        
        if (tab === 'summary') {
          optionSummary.classList.add('active');
          summaryInstructions.style.display = 'block';
        } else if (tab === 'full') {
          optionFull.classList.add('active');
          fullInstructions.style.display = 'block';
        } else if (tab === 'range') {
          optionRange.classList.add('active');
          rangeInstructions.style.display = 'block';
        }
      }
      
      optionSummary.addEventListener('click', () => switchTab('summary'));
      optionFull.addEventListener('click', () => switchTab('full'));
      optionRange.addEventListener('click', () => switchTab('range'));
      
      const copySummaryBtn = modal.querySelector('#copySummaryBtn');
      const copyFullBtn = modal.querySelector('#copyFullBtn');
      const copyRangeBtn = modal.querySelector('#copyRangeBtn');
      
      copySummaryBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(summaryPrompt);
        if (success) {
          copySummaryBtn.textContent = '\u2713 Copied!';
          copySummaryBtn.style.background = '#10b981';
          setTimeout(function() {
            copySummaryBtn.textContent = '\u{1F4CB} Copy Message';
            copySummaryBtn.style.background = '';
          }, 2000);
        }
      });
      
      copyFullBtn.addEventListener('click', async function() {
        const success = await copyToClipboard(fullPrompt);
        if (success) {
          copyFullBtn.textContent = '\u2713 Copied!';
          copyFullBtn.style.background = '#10b981';
          setTimeout(function() {
            copyFullBtn.textContent = '\u{1F4CB} Copy Message';
            copyFullBtn.style.background = '';
          }, 2000);
        }
      });
      
      copyRangeBtn.addEventListener('click', async function() {
        const startTurn = modal.querySelector('#rangeStart').value;
        const endTurn = modal.querySelector('#rangeEnd').value;
        const rangePrompt = `Alo, please provide turns ${startTurn} through ${endTurn} of our conversation in a clean, readable format that I can share.`;
        
        const success = await copyToClipboard(rangePrompt);
        if (success) {
          copyRangeBtn.textContent = '\u2713 Copied!';
          copyRangeBtn.style.background = '#10b981';
          setTimeout(function() {
            copyRangeBtn.textContent = '\u{1F4CB} Copy Range Message';
            copyRangeBtn.style.background = '';
          }, 2000);
        }
      });
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.opacity = '0';
        document.body.appendChild(textArea);
        textArea.select();
        const success = document.execCommand('copy');
        document.body.removeChild(textArea);
        return success;
      }
    }

    // =====================================================
    // API HELPER
    // =====================================================
    async function api(endpoint, method = 'GET', body = null) {
      const { data: { session } } = await supabase.auth.getSession();
      
      const options = {
        method,
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': session ? `Bearer ${session.access_token}` : `Bearer ${SUPABASE_ANON_KEY}`
        }
      };

      if (body && method !== 'GET') {
        options.body = JSON.stringify(body);
      }

      // For POST, add Prefer header to get minimal response
      if (method === 'POST') {
        options.headers['Prefer'] = 'return=minimal';
      }

      const response = await fetch(`${SUPABASE_URL}${endpoint}`, options);
      
      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const text = await response.text();
      return text ? JSON.parse(text) : null;
    }

    // =====================================================
    // LOAD CONNECTED STATE
    // =====================================================
    async function loadConnectedState() {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        
        if (!user) {
          resetToGuestUI();
          return;
        }

        const links = await api(`/rest/v1/therapist_clients?client_id=eq.${user.id}&status=eq.active`);

        if (!links || links.length === 0) {
          showLoggedInNoConnection();
          return;
        }

        therapistLink = links[0];
        clientId = user.id;

        const therapist = await api(`/rest/v1/profiles?id=eq.${therapistLink.therapist_id}&select=display_name`);
        const client = await api(`/rest/v1/profiles?id=eq.${user.id}&select=display_name`);

        const therapistName = therapist?.[0]?.display_name || 'Your therapist';
        const clientName = client?.[0]?.display_name || 'there';

        // P1: Read ALL chat settings — column names match dashboard's saveClientEdit()
        const settings = await api(`/rest/v1/therapist_clients?id=eq.${therapistLink.id}&select=allow_homework,allow_messages,allow_summary,allow_history`);
        chatSettings = settings?.[0] || {};

        showConnectedUI(therapistName, clientName);
        await loadHomework();

      } catch (err) {
        console.error('Error loading connected state:', err);
      }
    }

    // =====================================================
    // PRIVACY BAR
    // =====================================================
    function initPrivacyBar() {
      const bar = document.getElementById('privacyBar');
      const dismissBtn = document.getElementById('privacyBarDismiss');
      
      // Check if user has dismissed it before
      if (localStorage.getItem('alo_privacy_bar_dismissed')) {
        bar.style.display = 'none';
        return;
      }

      dismissBtn.addEventListener('click', () => {
        bar.style.display = 'none';
        localStorage.setItem('alo_privacy_bar_dismissed', 'true');
      });
    }

    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', async function() {
      const iframe = document.getElementById('aloFrame');
      const loadingOverlay = document.getElementById('loadingOverlay');
      let loadTimeout;

      iframe.addEventListener('load', function() {
        loadingOverlay.style.display = 'none';
        clearTimeout(loadTimeout);
      });

      loadTimeout = setTimeout(function() {
        loadingOverlay.innerHTML = `
          <div class="error-message">
            <p><strong>Still loading...</strong></p>
            <p>This is taking longer than usual. Let's try again.</p>
            <button onclick="location.reload()" class="btn-primary">Retry</button>
            <p style="font-size: 13px; margin-top: 20px; color: var(--text-secondary);">
              Need help now? Call <a href="tel:988" style="color: var(--text-primary);">988</a>
            </p>
          </div>
        `;
      }, 15000);

      // Privacy bar
      initPrivacyBar();

      // Event listeners
      document.getElementById('connectBtn').addEventListener('click', showConnectModal);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('privacyBtn').addEventListener('click', showPrivacyModal);
      document.getElementById('messageBtn').addEventListener('click', showMessageModal);
      document.getElementById('shareChat').addEventListener('click', showShareModal);
      
      document.getElementById('homeworkDoneBtn').addEventListener('click', handleHomeworkDone);
      
      document.getElementById('homeworkCollapseBtn').addEventListener('click', function() {
        const body = document.getElementById('homeworkBody');
        const btn = this;
        const isCollapsed = body.classList.contains('collapsed');
        body.classList.toggle('collapsed');
        btn.textContent = isCollapsed ? '\u2212' : '+';
        btn.setAttribute('aria-expanded', isCollapsed ? 'true' : 'false');
      });

      document.getElementById('homeworkHideBtn').addEventListener('click', function() {
        document.getElementById('homeworkContainer').classList.remove('show');
        showToast('Hidden for now. Tap here to see it again when you\u2019re ready.');
      });

      document.getElementById('termsLink').addEventListener('click', function(e) {
        e.preventDefault();
        createModal('Terms of Use', `
          <p>Alo is a conversational companion, not a replacement for professional mental health care.</p>
          <p style="margin-top: 12px;"><strong>By using Alo, you agree that:</strong></p>
          <ul class="modal-list">
            <li>Alo does not provide medical advice, diagnosis, or treatment</li>
            <li>You will seek professional help for mental health crises</li>
            <li>Your therapist does not see your conversations with Alo</li>
            <li>You are responsible for deciding what to share with your therapist</li>
          </ul>
          <p class="modal-divider">
            If you're in crisis, call <strong>988</strong> (US Suicide & Crisis Lifeline) or go to your nearest emergency room.
          </p>
        `, {
          confirmLabel: 'I understand',
          showCancel: false
        });
      });

      document.getElementById('privacyLink').addEventListener('click', function(e) {
        e.preventDefault();
        createModal('Privacy Policy', `
          <h3 class="modal-section-title">What we collect</h3>
          <ul class="modal-list">
            <li>Account information (email, password hash)</li>
            <li>Connection to your therapist</li>
            <li>Homework completion status</li>
            <li>Messages you send to your therapist</li>
          </ul>

          <h3 class="modal-section-title">What we don't collect</h3>
          <ul class="modal-list">
            <li><strong>Your conversations with Alo</strong></li>
            <li>Chat transcripts or history</li>
            <li>Personal details you share with Alo</li>
          </ul>

          <h3 class="modal-section-title">Who sees your data</h3>
          <ul class="modal-list">
            <li>Your therapist sees homework status and messages you send them</li>
            <li>Your therapist <strong>never</strong> sees your Alo conversations</li>
            <li>We don't sell or share your data with third parties</li>
          </ul>

          <p class="modal-divider">
            Questions? Contact your therapist or email support@along.inc
          </p>
        `, {
          confirmLabel: 'Got it',
          showCancel: false
        });
      });

      // Listen for auth state changes
      supabase.auth.onAuthStateChange((event, session) => {
        if (event === 'SIGNED_IN') {
          loadConnectedState();
        } else if (event === 'SIGNED_OUT') {
          resetToGuestUI();
        }
      });

      // Check for existing session
      const { data: { session } } = await supabase.auth.getSession();

      if (session) {
        await loadConnectedState();
      }
    });
  </script>
</body>
</html>
